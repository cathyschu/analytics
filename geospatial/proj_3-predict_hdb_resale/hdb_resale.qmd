---
title: "Predictive Modeling for Singapore HDB Resale Prices"
author: "Cathy C."
date: "Dec 4, 2025"
date-modified: "last-modified" #auto render date
format: html
execute: #how YML page work
  echo: true #will show code
  eval: true #will run code every time and show output
  warning: false #dont show warning msg
  freeze: true #controls rendering - no render if no changes
---

![](images/banner.png){fig-align="center" width="900"}

## 1 Overview

### 1.1 Background

Singapore housing price is a popular subject among locals and foreigners who are interested to purchase or invest in houses. While investors are typically interested in Condo or private housing due to policies and availabilty, Government housing like HDB is generally more affordable and a critical supply to Singaporeans from all walks of life. The resale market is especially important as Singaporeans looking to upgrade or PRs looking to purchase own housing.

This study is modified from a Geospatial course [assignment](https://isss626-ay2025-26aug.netlify.app/take-home_ex03) by Prof. Kam Tin Seong.

### 1.2 Objective

The objective of this study is to develop a spatially informed model to predict HDB resale prices in Singapore, making use of appropriate geospatial analytics methods. We will calibrate predictive models to predict HDB resale prices for the period July to September 2025, using HDB resale transaction data from July 2024 to June 2025.

### 1.3 The Task

In this study, we will first determine potential factors that influence the HDB resale price, import the data of these factors, and process them for predictive modeling. The modeling we will investigate in this task include Multi-linear Regression (MLR), Geographically Weighted Regression (GWR), non-spatial Random Forest, as well as Geographical Weighted Random Forest Model (gwRF). Among these models, we will examine and compare them to derive the best performing model.

## 2 Installing and Loading R packages

Below we will load the R packages. The table shows the packages used for this study and their descriptions, including links to more details to the package.

::: panel-tabset
## Load Packages

```{r}
pacman::p_load(httr, tidyverse, sf, tmap, jsonlite, progress,
               spdep, GWmodel, SpatialML, rsample, Metrics, knitr,
               kableExtra, spatialRF, randomForestExplainer, rvest,
               stringr, lubridate, corrplot, performance, see,
               gtsummary, ModelMetrics, DT, plotly)
```

## Package Intro

+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| R Package                                                                                      | Description                                                                                                                                                                                                                                                                                                                             |
+================================================================================================+=========================================================================================================================================================================================================================================================================================================================================+
| [**httr**](https://cran.r-project.org/web/packages/httr/index.html)                            | Useful tools for working with HTTP organised by HTTP verbs (GET(), POST(), etc).                                                                                                                                                                                                                                                        |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**tidyverse**](https://cran.r-project.org/web/packages/tidyverse/index.html)                  | an opinionated [collection of R packages](https://tidyverse.org/packages) designed for data science.\\, such as ggplot2, readr, stringr, lubridate, purrr, etc.                                                                                                                                                                         |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**sf**](https://cran.r-project.org/web/packages/sf/index.html)                                | Support for simple feature access, a standardized way to encode and analyze spatial vector data.                                                                                                                                                                                                                                        |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**tmap**](https://r-tmap.github.io/tmap/)                                                     | an R package for drawing thematic maps. The API is based on [*A Layered Grammar of Graphics*](https://vita.had.co.nz/papers/layered-grammar.pdf) and resembles the syntax of [ggplot2](https://cran.r-project.org/package=ggplot2), a popular R-library for drawing charts.                                                             |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**jsonlite**](https://cran.r-project.org/web/packages/jsonlite/index.html)                    | A reasonably fast JSON parser and generator, optimized for statistical data and the web.                                                                                                                                                                                                                                                |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**progress**](https://cran.r-project.org/web/packages/progress/index.html)                    | Provides a unifying API for reporting progress updates in R, including within parallel processing contexts. It was developed by Henrik Bengtsson, known for the `future` framework.                                                                                                                                                     |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**spdep**](https://cran.r-project.org/web/packages/spdep/index.html)                          | A collection of functions to create spatial weights matrix objects from polygon 'contiguities', from point patterns by distance and tessellations, for summarizing these objects, and for permitting their use in spatial data analysis, including regional aggregation by minimum spanning tree.                                       |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**GWmodel**](https://cran.r-project.org/web/packages/GWmodel/index.html)                      | Techniques from a particular branch of spatial statistics,termed geographicallyweighted (GW) models.                                                                                                                                                                                                                                    |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**SpatialML**](https://cran.r-project.org/web/packages/SpatialML/index.html)                  | Implements a spatial extension of the random forest algorithm ([Georganos et al. (2019](https://doi.org/10.1080%2F10106049.2019.1595177)). Allows for a geographically weighted random forest regression including a function to find the optical bandwidth. ([Georganos and Kalogirou (2022](https://www.mdpi.com/2220-9964/11/9/471)) |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**rsample**](https://rsample.tidymodels.org/)                                                 | provides functions to create different types of resamples and corresponding classes for their analysis.                                                                                                                                                                                                                                 |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**Metrics**](https://www.rdocumentation.org/packages/Metrics/versions/0.1.4)                  | An implementation of evaluation metrics in R that are commonly used in supervised machine learning. It implements metrics for regression, time series, binary classification, classification, and information retrieval problems.                                                                                                       |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**knitr**](https://cran.r-project.org/web/packages/knitr/index.html)                          | Provides a general-purpose tool for dynamic report generation in R using Literate Programming techniques.                                                                                                                                                                                                                               |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**corrplot**](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html) | provides a visual exploratory tool on correlation matrix that supports automatic variable reordering to help detect hidden patterns among variables.                                                                                                                                                                                    |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**performance**](https://easystats.github.io/performance/index.html)                          | provides utilities for computing **indices of model quality** and **goodness of fit**. These include measures like r-squared (R2), root mean squared error (RMSE) or intraclass correlation coefficient (ICC).                                                                                                                          |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**see**](https://easystats.github.io/see/)                                                    | As a core pillar of *easystats*, the *see* package helps users to utilize visualization for more informative, communicable, and well-rounded scientific reporting.                                                                                                                                                                      |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**gtsummary**](https://www.danieldsjoberg.com/gtsummary/)                                     | provides an elegant and flexible way to create publication-ready analytical and summary tables using the **R** programming language.                                                                                                                                                                                                    |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**ModelMetrics**](https://www.rdocumentation.org/packages/ModelMetrics/versions/1.2.2.2)      | ModelMetrics is a much faster and reliable package for evaluating models. ModelMetrics is written in using Rcpp making it faster than the other packages used for model metrics.                                                                                                                                                        |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| [**DT**](https://rstudio.github.io/DT/)                                                        | provides an R interface to the JavaScript library [**DataTables**](http://datatables.net/). R data objects (matrices or data frames) can be displayed as tables on HTML pages, and **DataTables** provides filtering, pagination, sorting, and many other features in the tables.                                                       |
+------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

: R Packages
:::

## 3 The Data

We will make use of the following data sets to prepare the predictors as well as dependent variable (i.e. HDB resale price) in the master dataset for predictive modeling.

::: panel-tabset
## Data sets

+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Data set                 | Description                                                                                                                  |
+==========================+==============================================================================================================================+
| **HDB**                  |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| HDB resale price         | Resale flat prices based on registration date from Jan-2017 onwards                                                          |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **Education**            |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Childcare centers        | Organisations offering play-based learning learning for younger kids.                                                        |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Kindergarten             | Singapore kindergartens, among which many are government-run to prepare older children for primary school.                   |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Primary schools          | Singapore primary schools                                                                                                    |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Top primary schools      | Top Singapore primary schools based on PSLE exam (secondary school entrance exam) results                                    |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **Business**             |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| CBD                      | The Central Business District areas, including RAFFLES PLACE, MARINA CENTRE, TANJONG PAGAR, CITY HALL, ENTRAL SUBZONE areas. |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Business park            | Areas where offices are concentrated across the island.                                                                      |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **Recreation**           |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Shopping malls           | Shopping mall buildings of all sizes.                                                                                        |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Sports halls             | Sports halls that provide sports facilities for the public use, including some school sports halls.                          |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Parks                    | Indicative polygon of Parks and Open Space in the Parks and Waterbodies Plan.                                                |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Community Clubs          | Common spaces for people of all races to come together, build friendships and promote social bonding.                        |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **F&B**                  |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Supermarkets             | Retail markets where people shop groceries.                                                                                  |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Foodcourt/Hawker centers | Footcourts and Hawker centers where people grab meals conveniently.                                                          |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **Transportation**       |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Bus                      | Bus stops                                                                                                                    |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| MRT                      | MRT & LRT stations                                                                                                           |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| **Healthcare**           |                                                                                                                              |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Clinics                  | Clinics / GP                                                                                                                 |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+
| Eldercare services       | Nursing homes, senior service centers                                                                                        |
+--------------------------+------------------------------------------------------------------------------------------------------------------------------+

## Sources

+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Data set                 | Source                                                                                                                                                                          |
+==========================+=================================================================================================================================================================================+
| **HDB**                  |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| HDB resale price         | [Resale flat prices](https://data.gov.sg/datasets?query=hdb+resale&resultId=d_8b84c4ee58e3cfc0ece0d773c8ca6abc)                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Education**            |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Childcare centers        | [Pre-Schools Location](https://data.gov.sg/datasets?query=preschool&resultId=d_61eefab99958fd70e6aab17320a71f1c&page=1)                                                         |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Kindergarten             | [Kindergartens](https://data.gov.sg/datasets?query=kindergarten&resultId=d_7fe9a72b1afff18e48111772c8d0fd39&page=1)                                                             |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Primary schools          | [School Directory and Information](https://data.gov.sg/datasets?query=school+information&resultId=457&page=1)                                                                   |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Top primary schools      | Primary school with data from [sophia education](https://sophiaeducation.sg/2025-singapore-psle-school-rankings/#%F0%9F%8F%AB_Top_20_Primary_Schools_in_Singapore_2025_Edition) |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Business**             |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| CBD                      | Shape file derived from Master Plan 2019 Planning Area Boundary                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Business park            | [JTC Business Park Land](https://data.gov.sg/datasets?query=park&page=1&resultId=d_7555d52fb87e75da7397bd65d4f107dd)                                                            |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Recreation**           |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Shopping malls           | -   [Shopping mall coordinates from Kaggle.](https://www.kaggle.com/datasets/karthikgangula/shopping-mall-coordinates)                                                          |
|                          |                                                                                                                                                                                 |
|                          | -   [Wiki page](https://en.wikipedia.org/wiki/List_of_shopping_malls_in_Singapore)                                                                                              |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Sports halls             | [SportsFields\@SG](https://data.gov.sg/datasets?query=sports+hub&page=1&resultId=d_f71b449b4b43a69b5ecfe411b440d249)                                                            |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Parks                    | [Park Facilities](https://data.gov.sg/datasets?query=park&page=1&resultId=d_14d807e20158338fd578c2913953516e)                                                                   |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Community Clubs          | [Community clubs geojson](https://data.gov.sg/datasets?query=community+club&resultId=d_f706de1427279e61fe41e89e24d440fa)                                                        |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **F&B**                  |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Supermarkets             | [Supermarkets (GEOJSON)](https://data.gov.sg/datasets?query=supermarket&resultId=d_cac2c32f01960a3ad7202a99c27268a0)2024                                                        |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Foodcourt/Hawker centers | [Hawker Centres (GEOJSON)](https://data.gov.sg/datasets?query=hawker+centre&page=1&resultId=d_4a086da0a5553be1d89383cd90d07ecd) 2025                                            |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Transportation**       |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Bus                      | [Bus stops location](https://datamall.lta.gov.sg/content/datamall/en/static-data.html)                                                                                          |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| MRT                      | [MRT & LRT station exits](https://datamall.lta.gov.sg/content/datamall/en/static-data.html)                                                                                     |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Healthcare**           |                                                                                                                                                                                 |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Clinics                  | [CHAS Clinics](https://data.gov.sg/datasets?query=clinic&resultId=d_548c33ea2d99e29ec63a7cc9edcccedc&page=1)                                                                    |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Eldercare services       | [Eldercare Services](https://data.gov.sg/datasets?query=eldercare&page=1&resultId=d_f0fd1b3643ed8bd34bd403dedd7c1533)                                                           |
+--------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
:::

### 2.1 Import Data

#### 2.1.0 Singapore Maps

Below we will import *Master Plan 2019 Subzone Boundary (No Sea).* from data.gov.sg.

::: panel-tabset
## Code

```{r}
#| eval: false
mpsz <- st_read("data/rawdata/MasterPlan2019SubzoneBoundaryNoSeaKML.kml") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

# extract values from the HTML description
extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
mpsz <- mpsz %>%
  mutate(
    REGION_N = map_chr(Description, extract_kml_field, "REGION_N"),
    PLN_AREA_N = map_chr(Description, extract_kml_field, "PLN_AREA_N"),
    SUBZONE_N = map_chr(Description, extract_kml_field, "SUBZONE_N"),
    SUBZONE_C = map_chr(Description, extract_kml_field, "SUBZONE_C")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())

write_rds(mpsz, "data/rds/mpsz.rds")
```

## Output

```{r}
#| echo: false
mpsz <- read_rds("data/rds/mpsz.rds")
st_crs(mpsz)
```
:::

#### 2.1.1 HDB resale data Preparation

::: panel-tabset
## Load data

-   **Load HDB Resale Data**

This data set comprises of HDB resale transactions from July 2017 onwards. Below we will extract a sub-set of transaction records on 4-Room flat transacted during July 2024 to June 2025.

```{r}
#| eval: false
#| code-fold: true

HDBresale <- read_csv(
  "data/rawdata/ResaleflatpricesJan2017.csv") %>%
  filter(flat_type == "4 ROOM") %>%
  filter(month >= "2024-07" & month <= "2025-09") # filter the sample data for the exercise till 09/2025.

write_rds(HDBresale, "data/rds/HDBresale.rds")
```

```{r}
#| echo: false
HDBresale <- read_rds("data/rds/HDBresale.rds")
kable(head(HDBresale, 5))

```

## Street names

-   **Further processing for street names**

We do further processing for the data as the street names with Saint are usually written as St.

```{r}
#| eval: false
#| code-fold: true
# street names is ST, but it's actually Sait.
HDBresale$street_name <- gsub(
  "ST\\.", "SAINT",
  HDBresale$street_name
)
```

```{r}
#| echo: false
HDBresale <- read_rds("data/rds/HDBresale.rds")
glimpse(HDBresale)
```

## Geocoding Resale Data

We use OneMap Geocode API: - <https://www.onemap.gov.sg/apidocs/.> - <https://www.onemap.gov.sg/apidocs/reverseGeocode>

Below we will prepare a geocoding function. It aims to perform the following tasks:

-   Combining the block and street name into an address. The addresses will be used to geocode instead of postal code
-   Passing the address as the **searchVal** in our query
-   Sending the query to **OneMapSG search**. Note: Since we don’t need all the address details, we can set getAddrDetails as ‘N’
-   Converting response (JSON object) to text
-   Saving response in text form as a dataframe
-   Retain the latitude and longitude for our output.

```{r}
#| eval: false
#| code-fold: true
# for multiple queries
geocode <- function(block, streetname) {
  base_url <- "https://onemap.gov.sg/api/common/elastic/search"
  address <- paste(block, streetname, sep = " ")
  query <- list("searchVal" = address,
                "returnGeom" = "Y",
                "getAddrDetails" = "N", #No. can change to Y for comparison
                "pageNum" = "1") 
  res <- GET(base_url, query = query) #get URL query
  restext <- content(res, as = "text")
  
  output <- fromJSON(restext) %>%
    as.data.frame %>%
    select(results.LATITUDE, results.LONGITUDE)
  
  return(output)
}
```

-   **Run functions**

```{r}
#| eval: false
#| code-fold: true
HDBresale$LATITUDE <- 0
HDBresale$LONGITUDE <- 0

for(i in 1:nrow(HDBresale)){
  temp_output <- geocode(HDBresale[i, 4], HDBresale[i, 5])
  
  HDBresale$LATITUDE[i] <- temp_output$results.LATITUDE
  HDBresale$LONGITUDE[i] <- temp_output$results.LONGITUDE
}
```

## sf objects transformation

-   **Transform to sf data frame**

We want to ensure that: - both input data sets must be in sf objects - they must be in similar projected coordinates systems

```{r}
#| eval: false
#| code-fold: true

st_crs(HDBresale)
HDBresale_sf <- HDBresale %>%
  st_as_sf(
    coords = c("LONGITUDE", "LATITUDE"),
    crs = 4326) %>% #if decimal degree
  st_transform(crs = 3414)

write_rds(HDBresale_sf, "data/rds/HDBresale_sf.rds")
```

```{r}
#| echo: false
HDBresale_sf <- read_rds("data/rds/HDBresale_sf.rds")
kable(head(HDBresale_sf, 5))
```
:::

#### 2.1.2 Load location factors data

We determined the predict factors in 2 categories. One is structural factors, and the other is location factors.

::: panel-tabset
## Structural factors

-   Area of the unit
-   Floor level
-   Planning area (town)
-   Remaining lease
-   Age of the unit

## Location factors

-   Proxomity to CBD
-   Proxomity to business park
-   Proximity to eldercare
-   Proximity to foodcourt/hawker centres
-   Proximity to MRT
-   Proximity to park
-   Proximity to top primary school
-   Proximity to shopping mall
-   Proximity to supermarket
-   Proximity to healthcare facilities
-   Proximity to sports halls
-   Proximity to community clubs
-   Numbers of kindergartens within 350m
-   Numbers of childcare centres within 350m
-   Numbers of bus stop within 350m
-   Numbers of primary school within 1km
:::

Below we will start processing the data for these predictive factors.

::: panel-tabset
## Education

[**CHILDCARE CENTERS**]{style="color: #F08787;"}

For childcare centers, we derive a geometry point to compute numbers of childcare centers within 350m to the HDB units.

```{r}
#| eval: false
#| code-fold: true
preschool_data <- st_read("data/rawdata/PreschoolsLocation.kml") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
preschool_data <- preschool_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "CENTRE_NAME")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())

write_rds(preschool_data, "data/rds/preschool_data.rds")
```

```{r}
#| echo: false
preschool_data <- read_rds("data/rds/preschool_data.rds")
summary(preschool_data)

```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(preschool_data, 3))
```

[**KINDERGARTENS**]{style="color: #F08787;"}

For kindergartens, we derive a geometry point to compute numbers of childcare centers within 350m to the HDB units.

```{r}
#| eval: false
#| code-fold: true
kindergarten_data <- st_read("data/rawdata/Kindergartens.geojson") %>%
  st_transform(crs = 3414) %>%
  select(OBJECTID, NAME, geometry, DESCRIPTION)

write_rds(kindergarten_data, "data/rds/kindergarten_data.rds")
```

```{r}
#| echo: false
#| code-fold: true
kindergarten_data <- read_rds("data/rds/kindergarten_data.rds")
summary(kindergarten_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(kindergarten_data, 3))
```

[**PRIMARY SCHOOLS**]{style="color: #F08787;"}

For primary schools, we derive a geometry point to compute numbers of childcare centers within 350m to the HDB units.

```{r}
#| code-fold: true
#| eval: false
primschool_data <- read_csv("data/rawdata/General Information of schools.csv") %>%
  select(school_name, postal_code, address)
```

Below we need to geocode the primary school location because currently we have their postal codes.

```{r}
#| code-fold: true
#| eval: false
geocode_postal <- function(postal_code) {
  url <- paste0("https://www.onemap.gov.sg/api/common/elastic/search?",
                "searchVal=", postal_code,
                "&returnGeom=Y&getAddrDetails=Y")
  
  response <- GET(url)
  
  if (status_code(response) == 200) {
    result <- content(response, "text") %>% fromJSON()
    
    if (result$found > 0) {
      return(data.frame(
        latitude = as.numeric(result$results$LATITUDE[1]),
        longitude = as.numeric(result$results$LONGITUDE[1])
      ))
    }
  }
  
  return(data.frame(latitude = NA, longitude = NA))
}

# Geocode all primary schools
primschool_coords <- lapply(primschool_data$postal_code, function(pc) {
  Sys.sleep(0.2)  
  geocode_postal(pc)
})

primschool_coords_df <- bind_rows(primschool_coords)

primschool_data <- primschool_data %>%
  bind_cols(primschool_coords_df)

# Convert to sf object
primschool_data <- primschool_data %>%
  filter(!is.na(latitude)) %>%  # Remove any that failed
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(3414)  # Transform to SVY21

nrow(primschool_data)  # How many successfully geocoded
```

We examine the school list and check what schools we will filter out using keywords, and derive the geometry point for all primary schools in the list.

```{r}
#| code-fold: true
#| eval: false
primschool_data %>%
  filter(
    grepl("SECONDARY|HIGH|INSTITUTE|INSTITUTION|SCHOOL OF|JUNIOR|COLLEGE", 
               school_name, 
               ignore.case = TRUE)) %>%

# Remove non-primary schools 
  filter(school_name %in% 
           c("MARIS STELLA HIGH SCHOOL", "CATHOLIC HIGH SCHOOL") |
           !grepl("SECONDARY|HIGH|INSTITUTE|INSTITUTION|
                  SCHOOL OF|JUNIOR|COLLEGE", 
                  school_name, ignore.case = TRUE)) %>%
  filter(!school_name %in% 
           c("CHIJ KATONG CONVENT", "CHIJ ST. JOSEPH'S CONVENT"))

write_rds(primschool_data, "data/rds/primschool_data.rds") 
```

```{r}
#| echo: false
primschool_data <- read_rds("data/rds/primschool_data.rds")
summary(primschool_data)

```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(primschool_data, 3))
```

[**TOP PRIMARY SCHOOLS**]{style="color: #F08787;"}

We identify top 20 primary school from [sophia education](https://sophiaeducation.sg/2025-singapore-psle-school-rankings/#%F0%9F%8F%AB_Top_20_Primary_Schools_in_Singapore_2025_Edition) eestimated by exam scrores and academic excellence.

```{r}
#| code-fold: true
#| eval: false
top_primschool_data <- primschool_data %>%
  filter(school_name %in% c("RAFFLES GIRLS' PRIMARY SCHOOL", "NANYANG PRIMARY SCHOOL",
                          "HENRY PARK PRIMARY SCHOOL", "ROSYTH SCHOOL",
                          "AI TONG SCHOOL", "NAN HUA PRIMARY SCHOOL", "ST. HILDA'S PRIMARY SCHOOL",
                          "TAO NAN SCHOOL", "CHIJ ST. NICHOLAS GIRLS' SCHOOL",
                          "CATHOLIC HIGH SCHOOL", "PEI HWA PRESBYTERIAN PRIMARY SCHOOL",
                          "METHODIST GIRLS' SCHOOL (PRIMARY)", "KONG HWA SCHOOL",
                          "RED SWASTIKA SCHOOL", "SINGAPORE CHINESE GIRLS' SCHOOL", "MARIS STELLA HIGH SCHOOL",
                          "ANGLO-CHINESE SCHOOL (PRIMARY)", "TEMASEK PRIMARY SCHOOL","RIVER VALLEY PRIMARY SCHOOL",
                          "CEDAR PRIMARY SCHOOL"))

write_rds(top_primschool_data, "data/rds/top_primschool_data.rds")
```

```{r}
#| echo: false

top_primschool_data <- read_rds("data/rds/top_primschool_data.rds")
summary(top_primschool_data)
```

## Business

Proximity to offices is a factor when people consider buying a house. We assume that a shorter the distance to the offices drives higher purchasing value. In this study, we consider proximity to the CBD area and other business parks across the island.

[**CBD**]{style="color: #F08787;"}

For CBD, we will extract the area for CBD from `mpsz`.

```{r}
#| code-fold: true
#| eval: false
cbd_data <- mpsz %>%
  filter(SUBZONE_N %in% c("RAFFLES PLACE", "MARINA CENTRE", "TANJONG PAGAR", "CITY HALL", "CENTRAL SUBZONE")) %>%
  st_union()

write_rds(cbd_data, "data/rds/cbd_data.rds")
```

```{r}
#| echo: false
cbd_data <- read_rds("data/rds/cbd_data.rds")
summary(cbd_data)
```

*cbd_data* is now a single merged polygon representing the entire CBD area. We will use this to calculate distance in later section.

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(cbd_data, 3))
```

[**BUSINESS PARKS**]{style="color: #F08787;"}

Business parks are typically smaller than planning areas, and we have multiple business parks to consider. Therefore, we will calculate centroid for measuring proximity, and transform polygon data to centroid point data.

```{r}
#| code-fold: true
#| eval: false

bizpark_data <- st_read("data/rawdata/JTCBusinessParkLandGEOJSON.geojson") %>% 
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414) %>%
  st_centroid() %>%
  select(OBJECTID_1, LANDUSE, geometry)

write_rds(bizpark_data, "data/rds/bizpark_data.rds")
```

```{r}
#| echo: false
bizpark_data <- read_rds("data/rds/bizpark_data.rds")
summary(bizpark_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(bizpark_data, 3))
```

## Recreation

[**SHOPPING MALLS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false

sgmalls_rawdata <- read_csv("data/rawdata/singapore_malls.csv") %>%
  filter(!Mall_Name %in% c('JCube', 'JCube (closed)', 'Liang Court', 'Lot 1', 
                           'Nex', 'Novena Square Shopping Mall'))

sgmalls_coordinates <- read_csv("data/rawdata/shopping_mall_coordinates.csv") %>%
  rename(Mall_Name = 'Mall Name')

merged_malls <- full_join(sgmalls_rawdata, sgmalls_coordinates, by = "Mall_Name")

```

After the merge, we examine if any shopping malls turn out without coordinates data.

```{r}
#| code-fold: true
#| eval: false
malls_without_coords <- merged_malls %>%
  filter(is.na(LONGITUDE) | is.na(LATITUDE)) %>%
  pull(Mall_Name)

malls_without_coords
```

Among checks, we identified some malls no longer in business:

-   Amber Mansions: demolished in 1984
-   Bedok Point
-   Capitol Centre
-   Ellenborough Market
-   Funan DigitaLife Mall: duplicate
-   Great World: duplicate
-   GV Yishun: cinema
-   Jurong Entertainment Centre: demolished 2010
-   Shaw Tower: demolished
-   Specialists' Shopping Centre: redeveloped as Orchard Gateway
-   Tanglin Shopping Centre: CLOSED
-   The Golden Mile: CLOSED
-   The Verge: closed
-   Woodland Mall: renamed to Woods square mall

For other malls, we manually check with Google maps and add the coordinates into the data set.

```{r}
#| code-fold: true
#| eval: false

coords_to_fill <- tibble(
  Mall_Name = c("Alexandra Retail Centre", "Capitol Singapore", "Change Alley",
                "Chinatown Point", "Clementi Mall", "Dawson Place", 
                "Esplanade Mall", "Forum The Shopping Mall", "Fu Lu Shou Complex", 
                "HarbourFront Centre", "Holland Road Shopping Centre", 
                "Holland Village Shopping Mall", 
                "Mandarin Gallery", "Mustafa Centre", "Novena Square", 
                "Orchard Towers", "Paya Lebar Quarter", "Peninsula Plaza",
                "Punggol Coast Mall", "Scotts Shopping Centre", "Seletar Mall",
                "Shaw House and Centre", "Singpost Center",
                "South Beach", "Suntec City Mall",
                "Tang Plaza", "The Cathay", 
                "The Majestic", "The Rail Mall", 
                "VivoCity", "Woodland Mall"),
  
  LONGITUDE = c(103.8015, 103.8511, 103.8518, 
                103.8446, 103.7642, 103.8107,
                103.8561, 103.8284, 103.8543,
                103.8201, 103.7952, 
                103.7937, 
                103.8363, 103.8554, 103.8439,
                103.8292, 103.8930, 103.8508,
                103.9104, 103.8329, 103.8758,
                103.8318, 103.8940, 
                103.8557, 103.8581, 
                103.8329, 103.8477,
                103.8432, 103.7678,
                103.8231, 103.7859
                ),
  LATITUDE = c(1.2741176, 1.293231, 1.284643, 
               1.285434, 1.315111, 1.293505, 
               1.290017, 1.306391, 1.301906,
               1.265355, 1.310419, 1.319192,
               
               1.311708, 
               1.317859, 1.292544, 1.302237, 
               1.310192, 1.320230, 1.307743, 
               1.415818, 1.306093, 1.392464,
               1.306507, 
               1.294485, 1.295778, 
               1.305221, 1.300409, 
               1.284871, 1.358212, 
               1.265357, 1.438082
               )
) 

merged_malls <- merged_malls %>%
  rows_update(coords_to_fill, by = "Mall_Name", unmatched = "ignore")

merged_malls <-  merged_malls %>%
  mutate(
    Mall_Name = case_when(
      Mall_Name == "Woods Square Mall" ~ "Woodland Mall",
      TRUE ~ Mall_Name
    )
  )

# add new mall data
new_malls <- tibble(
  Mall_Name = "Woodleigh Mall",
  LONGITUDE = 103.8718,
  LATITUDE = 1.339560
)  

merged_malls <- merged_malls %>%
  bind_rows(new_malls)
```

Check the malls with missing coordinates.

```{r}
#| code-fold: true
#| eval: false
malls_with_na <- merged_malls %>%
  filter(is.na(LONGITUDE) | is.na(LATITUDE)) 

write_rds(malls_with_na, "data/rds/malls_with_na.rds")

```

```{r}
#| echo: false

malls_with_na <- read_rds("data/rds/malls_with_na.rds")
kable(malls_with_na)
```

These malls are the ones duplicate or closed. We will go ahead to remove them. We will also remove 2 duplicate malls observed from *merged_malls*.

```{r}
#| code-fold: true
#| eval: false
merged_malls <- merged_malls %>%
  filter(!is.na(LONGITUDE) & !is.na(LATITUDE)) %>%
  distinct(Mall_Name, .keep_all = TRUE) %>%
  filter(!Mall_Name %in% c("Suntec City Mall", "Capitol Piazza"))

# Check how many remain
nrow(merged_malls)

# merged_malls has long, lat coordinates. We want to convert it to sf object, then SVY21.
merged_malls <- merged_malls %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326) %>%  # it's WGS84
  st_transform(3414)  

write_rds(merged_malls, "data/rds/malls_data.rds")
```

```{r}
#| echo: false
malls_data <- read_rds("data/rds/malls_data.rds")
summary(malls_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(malls_data, 3))
```

[**SPORTS HALLS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false
sports_data <- st_read("data/rawdata/SportsFieldsSG.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
sports_data <- sports_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "NAME"),
    description = map_chr(Description, extract_kml_field, "DESCRIPTION")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col()) %>%
  select(-description)

write_rds(sports_data, "data/rds/sports_data.rds")
```

```{r}
#| echo: false
sports_data <- read_rds("data/rds/sports_data.rds")
summary(sports_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(sports_data, 3))
```

[**PARKS**]{style="color: #F08787;"}

For the parks, we will compute centroid for each park and open space.

```{r}
#| code-fold: true
#| eval: false
park_data <- st_read("data/rawdata/MasterPlan2019SDCPParkandOpenSpacelayer.kml") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_make_valid() %>%
  st_transform(crs = 3414)

# Calculate centroids 
park_data <- park_data %>%
  mutate(centroid = st_centroid(geometry)) %>%
  select(-Description)

write_rds(park_data, "data/rds/park_data.rds")
```

```{r}
#| echo: false
park_data <- read_rds("data/rds/park_data.rds")
summary(park_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(park_data, 3))
```

[**COMMUNITY CLUBS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false
cc_data <- st_read("data/rawdata/CommunityClubs.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

cc_data <- cc_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "NAME")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())

write_rds(cc_data, "data/rds/cc_data.rds")
```

```{r}
#| echo: false
cc_data <- read_rds("data/rds/cc_data.rds")
summary(cc_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(cc_data, 3))
```

## F&B

[**FOODCOURT/HAWKER CENTERS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false
hkcenter_data <- st_read("data/rawdata/HawkerCentresGEOJSON.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414) %>%
  select(OBJECTID, NAME, geometry, STATUS)

write_rds(hkcenter_data, "data/rds/hkcenter_data.rds")

```

```{r}
#| echo: false
hkcenter_data <- read_rds("data/rds/hkcenter_data.rds")
summary(hkcenter_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(hkcenter_data, 3))
```

Below we will check the status of these hawker centers, and find that all are either existing or under construction. None has stopped the business, so we will keep all these.

```{r}
unique(hkcenter_data$STATUS)
```

[**SUPERMARKETS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false

supermarkets_data <- st_read("data/rawdata/SupermarketsGEOJSON.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)
# # calculate centroids
#   mutate(centroid = st_centroid(geometry)) %>%
#   select(OBJECTID_1, centroid)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
supermarkets_data <- supermarkets_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "LIC_NAME"),
    postcode = map_chr(Description, extract_kml_field, "POSTCODE")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())  

write_rds(supermarkets_data, "data/rds/supermarkets_data.rds")  
```

```{r}
#| echo: false
supermarkets_data <- read_rds("data/rds/supermarkets_data.rds")
summary(supermarkets_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(supermarkets_data, 3))
```

## Transportation

[**MRT**]{style="color: #F08787;"}

Below we will import MRT station exit shapefile. The MRT stations may have multiple exits, and these exits matter when people go through them to enter or exit the stations. We will use the data to compute for proximity to HDB units.

```{r}
#| code-fold: true
mrt_data <- st_read("data/rawdata/TrainStationExit_Feb2025/Train_Station_Exit_Layer.shp") %>%
  st_transform(crs = 3414)

summary(mrt_data)

```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(mrt_data, 3))
```

[**BUS STOPS**]{style="color: #F08787;"}

Below we will import *Bus Stop Location* shapfile from LTA DataMall.

```{r}
#| code-fold: true
#| eval: false
bus_data = st_read(dsn = "data/rawdata/BusStopLocation_Aug2025",
                  layer = "BusStop")
bus_data <- bus_data %>%
  st_transform(crs = 3414)

write_rds(bus_data, "data/rds/bus_data.rds")
```

```{r}
#| echo: false
bus_data <- read_rds("data/rds/bus_data.rds")
summary(bus_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(bus_data, 3))
```

## Healthcare

[**CLINICS**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false

clinics_data <- st_read("data/rawdata/CHASClinics.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
clinics_data <- clinics_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "HCI_NAME")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())

write_rds(clinics_data, "data/rds/clinics_data.rds")

```

```{r}
#| echo: false
clinics_data <- read_rds("data/rds/clinics_data.rds")
summary(clinics_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(clinics_data, 3))
```

[**ELDERCARE SERVICES**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| eval: false

eldercare_data <- st_read("data/rawdata/EldercareServices.geojson") %>%
  st_zm(drop = TRUE, what = "ZM") %>%
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  
  page <- read_html(html_text)
  rows <- page %>% html_elements("tr")
  
  value <- rows %>%
    keep(~ html_text2(html_element(.x, "th")) == field_name) %>%
    html_element("td") %>%
    html_text2()
  
  if (length(value) == 0) NA_character_ else value
}

# extract info
eldercare_data <- eldercare_data %>%
  mutate(
    name = map_chr(Description, extract_kml_field, "NAME")
  ) %>%
  select(-Name, -Description) %>%
  relocate(geometry, .after = last_col())

write_rds(eldercare_data, "data/rds/eldercare_data.rds")

```

```{r}
#| echo: false
eldercare_data <- read_rds("data/rds/eldercare_data.rds")
summary(eldercare_data)
```

[**Quick view of the data set**]{style="color: #96A78D;"}

```{r}
kable(head(eldercare_data, 3))
```
:::

#### 2.1.3 Initial data inspection

We validate the coordinates of the location factor data below. It shows us that all now conform to **SVY21**, and ready for proximity computation.

::: panel-tabset
## Result

```{r}
#| echo: false
cat('Business Park bizpark_data: ',st_crs(bizpark_data)$epsg, '\n','\n',
'CBD cbd_data: ', st_crs(cbd_data)$epsg, '\n','\n',
'Clinics clinics_data: ', st_crs(clinics_data)$epsg, '\n','\n',
'Eldercare Services eldercare_data: ', st_crs(eldercare_data)$epsg, '\n','\n',
'Foodcourt/Hawker Centers hkcenter_data: ', st_crs(hkcenter_data)$epsg, '\n','\n',
'Shopping malls malls_data: ', st_crs(malls_data)$epsg, '\n','\n',
'MRT mrt_data: ', st_crs(mrt_data)$epsg, '\n','\n',
'Parks park_data: ', st_crs(park_data)$epsg, '\n','\n',
'Childcares preschool_data: ', st_crs(preschool_data)$epsg, '\n','\n',
'Primary Schools primschool_data: ', st_crs(primschool_data)$epsg, '\n','\n',
'Supermarkets supermarkets_data: ', st_crs(supermarkets_data)$epsg, '\n','\n',
'Sports halls sports_data: ', st_crs(sports_data)$epsg, '\n','\n',
'Bus stops bus_data: ', st_crs(bus_data)$epsg, '\n','\n',
'Kindergartens kindergarten_data: ', st_crs(kindergarten_data)$epsg, '\n','\n',
'Community Clubscc_data: ', st_crs(cc_data)$epsg)
```

## Code

```{r}
#| eval: false
cat('Business Park bizpark_data: ',st_crs(bizpark_data)$epsg, '\n','\n',
    'CBD cbd_data: ', st_crs(cbd_data)$epsg, '\n','\n',
    'Clinics clinics_data: ', st_crs(clinics_data)$epsg, '\n','\n',
    'Eldercare Services eldercare_data: ', st_crs(eldercare_data)$epsg, '\n','\n',
    'Foodcourt/Hawker Centers hkcenter_data: ', st_crs(hkcenter_data)$epsg, '\n','\n',
    'Shopping malls malls_data: ', st_crs(malls_data)$epsg, '\n','\n',
    'MRT mrt_data: ', st_crs(mrt_data)$epsg, '\n','\n',
    'Parks park_data: ', st_crs(park_data)$epsg, '\n','\n',
    'Childcares preschool_data: ', st_crs(preschool_data)$epsg, '\n','\n',
    'Primary Schools primschool_data: ', st_crs(primschool_data)$epsg, '\n','\n',
    'Supermarkets supermarkets_data: ', st_crs(supermarkets_data)$epsg, '\n','\n',
    'Sports halls sports_data: ', st_crs(sports_data)$epsg, '\n','\n',
    'Bus stops bus_data: ', st_crs(bus_data)$epsg, '\n','\n',
    'Kindergartens kindergarten_data: ', st_crs(kindergarten_data)$epsg, '\n','\n',
    'Community Clubscc_data: ', st_crs(cc_data)$epsg)

```
:::

### 2.2 Structural factors

The tructural factors for this study include flat type, floor level, town, planning area, area of unit, age of unit, main upgrading program, and flat model. Currently in our data, we have the variables shown below:

```{r}
names(HDBresale_sf)
```

We will rename some of the factors and keep the factors being used for the study. In addition, we will convert the floor range `storey_range` to numerical variable, using its lowest level, and rename the varaible to `floor_level`. We will also calculate the unit age using the `lease_commence_date` variable.

```{r}
#| code-fold: true
#| eval: false
HDBresale_sf_rename <- HDBresale_sf %>%
  rename(transact_date = month,
         remaining_lease_mths = remaining_lease,
         floor_level = storey_range,
         plan_area = town) %>%
  mutate(floor_level = as.numeric(substr(floor_level, 1, 2)),
         age = 2025 - lease_commence_date) %>%
    select(transact_date, resale_price, floor_level, plan_area, 
         floor_area_sqm, flat_model, 
         remaining_lease_mths, age, geometry) 

write_rds(HDBresale_sf_rename, "data/rds/HDBresale_sf_rename.rds")  
```

```{r}
#| echo: false
HDBresale_sf_rename <- read_rds("data/rds/HDBresale_sf_rename.rds")
glimpse(HDBresale_sf_rename)
```

For predictive modeling, we should change data type for the following variables: `transact_date` and `remaining_lease_mths` to date and numeric data type respectively.

```{r}
#| code-fold: true
#| eval: false

# convert transction date to date data type
HDB_data <- HDBresale_sf_rename %>%
  mutate(
    transact_date = as.Date(paste0(transact_date, "-01")),
    
    # Extract years
    years = as.numeric(str_extract(remaining_lease_mths, "\\d+(?= year)")),
    # Extract months
    months = as.numeric(str_extract(remaining_lease_mths, "\\d+(?= month)")),

    years = ifelse(is.na(years), 0, years),
    months = ifelse(is.na(months), 0, months),

    remaining_lease_mths_num = years * 12 + months
  ) %>%
  select(-years, -months)  # Remove temporary columns
write_rds(HDB_data, "data/rds/HDB_data.rds")
```

Below we confirm the transction date is now `Date` data type and the remaining lease is in `numeric` data type as months.

```{r}
#| echo: false
HDB_data <- read_rds("data/rds/HDB_data.rds")

head(HDB_data$transact_date, 10)
class(HDB_data$transact_date)
class(HDB_data$remaining_lease_mths_num)
```

### 2.3 Proximity Analysis

In this section, we will prepare location factors of their proximity to the HDB units and the availability of these facilities within a fixed distance of the HDB housing.

#### 2.3.1 Computing shortest distance

We would like to use proximity from the HDB units to the location factors to predict the resale price. When one purchases housing, distance to useful facilities is always a consideration or value drivers. For example, an HDB unit being only 100m away would be very different from 500m away from the nearest MRT station, as it takes longer time to commute and can be inconvenient in rainy and hot days.

Therefore, below we will compute the distance between the nearest facilities/infrastructures from each HDB resale property. The distance computed would be in meters.

::: panel-tabset
## Education

```{r}
#| code-fold: true
#| eval: false

# Top Primary school
HDB_combine_edu <- HDB_data %>%
  mutate(
    PROX_TOPSCHOOL = as.numeric(
      st_distance(geometry,
                  top_primschool_data[st_nearest_feature(
                    geometry, top_primschool_data), ], 
                  by_element = TRUE)
      ))
write_rds(HDB_combine_edu, "data/rds/HDB_combine_edu.rds")
```

```{r}
#| code-fold: true
HDB_combine_edu <- read_rds("data/rds/HDB_combine_edu.rds")
kable(head(HDB_combine_edu, 3))
```

## F&B

```{r}
#| code-fold: true
#| eval: false

# Hawker centers
HDB_combine_2fb <- HDB_combine_edu %>%
  mutate(
    PROX_HKCENTER = as.numeric(
      st_distance(geometry,
                  hkcenter_data[st_nearest_feature(
                    geometry, hkcenter_data), ], 
                  by_element = TRUE)),
# Supermarkets
    PROX_SUPERMKT =  as.numeric(
      st_distance(geometry,
                  supermarkets_data[st_nearest_feature(
                    geometry, supermarkets_data), ], 
                  by_element = TRUE))
    )

write_rds(HDB_combine_2fb, "data/rds/HDB_combine_2fb.rds")
```

```{r}
#| code-fold: true
HDB_combine_2fb <- read_rds("data/rds/HDB_combine_2fb.rds")
kable(head(HDB_combine_2fb, 3))
```

## Healthcare

```{r}
#| code-fold: true
#| eval: false
# Clinics
HDB_combine_3hc <- HDB_combine_2fb %>%
  mutate(
    PROX_CLINIC = as.numeric(
      st_distance(geometry,
                  clinics_data[st_nearest_feature(
                    geometry, clinics_data), ], 
                  by_element = TRUE)),
# Eldercare
    PROX_ELDERCARE =  as.numeric(
      st_distance(geometry,
                  eldercare_data[st_nearest_feature(
                    geometry, eldercare_data), ], 
                  by_element = TRUE))
    )

write_rds(HDB_combine_3hc, "data/rds/HDB_combine_3hc.rds")
```

```{r}
#| code-fold: true
HDB_combine_3hc <- read_rds("data/rds/HDB_combine_3hc.rds")
kable(head(HDB_combine_3hc, 3))
```

## Recreation

```{r}
#| code-fold: true
#| eval: false
# Shopping mall
HDB_combine_4rc <- HDB_combine_3hc %>%
  mutate(
    PROX_MALLS = as.numeric(
      st_distance(geometry,
                  malls_data[st_nearest_feature(
                    geometry, malls_data), ], 
                  by_element = TRUE)),
# Sports hall
    PROX_SPORTS =  as.numeric(
      st_distance(geometry,
                  sports_data[st_nearest_feature(
                    geometry, sports_data), ], 
                  by_element = TRUE)),
# Community Club
    PROX_CC =  as.numeric(
      st_distance(geometry,
                  cc_data[st_nearest_feature(
                    geometry, cc_data), ], 
                  by_element = TRUE)),
# Parks
    PROX_PARK =  as.numeric(
      st_distance(geometry,
                  park_data[st_nearest_feature(
                    geometry, park_data), ], 
                  by_element = TRUE))
    )

write_rds(HDB_combine_4rc, "data/rds/HDB_combine_4rc.rds")
```

```{r}
#| code-fold: true
HDB_combine_4rc <- read_rds("data/rds/HDB_combine_4rc.rds")
kable(head(HDB_combine_4rc, 3))
```

## Transportation

```{r}
#| code-fold: true
#| eval: false
# Shopping mall
HDB_combine_5transp <- HDB_combine_4rc %>%
  mutate(
    PROX_MRT = as.numeric(
      st_distance(geometry,
                  mrt_data[st_nearest_feature(
                    geometry, mrt_data), ], 
                  by_element = TRUE))
    )

write_rds(HDB_combine_5transp, "data/rds/HDB_combine_5transp.rds")
```

```{r}
#| code-fold: true
HDB_combine_5transp <- read_rds("data/rds/HDB_combine_5transp.rds")
kable(head(HDB_combine_5transp, 3))
```

## Business

```{r}
#| code-fold: true
#| eval: false
# CBD
HDB_combine_6biz <- HDB_combine_5transp %>%
  mutate(
    PROX_CBD = as.numeric(
      st_distance(geometry,
                  cbd_data)),
    PROX_BIZPK = as.numeric(
      st_distance(geometry,
                  cbd_data)),
# Business parks
    PROX_BIZPK = as.numeric(
      st_distance(geometry,
                  bizpark_data[st_nearest_feature(
                    geometry, bizpark_data), ], 
                  by_element = TRUE))
    )
write_rds(HDB_combine_6biz, "data/rds/HDB_combine_6biz.rds")
```

```{r}
#| code-fold: true
HDB_combine_6biz <- read_rds("data/rds/HDB_combine_6biz.rds")
kable(head(HDB_combine_6biz, 3))
```
:::

#### **2.3.2 Create binary proximity indicators**

Next we will derive a binary data to find out which schools are within 350 meters. `st_is_within_distance()` of [**sf**]{style="color: #F08787;"} package is used to determine whether two spatial objects (HDB property and preschool) are within a set distance of each other. It returns a logical matrix (or a sparse list of indices if sparse = TRUE) indicating for each geometry in HDB property which geometries in the facility are within the set distance.

::: panel-tabset
## Top primary school

Within 1 km

```{r}
#| code-fold: true
#| eval: false
within_1km <- st_is_within_distance(
  HDB_data, top_primschool_data, dist = 1000)

HDB_combine_7bi_primschool <- HDB_combine_6biz %>%
  mutate(
    WITHIN_1km_TOPPRISCH = map_int(within_1km, length),
    WITHIN_1km_TOPPRISCH_BINARY = ifelse(WITHIN_1km_TOPPRISCH > 0, 1, 0)
)
write_rds(HDB_combine_7bi_primschool, "data/rds/HDB_combine_7bi_primschool.rds")
```

```{r}
#| code-fold: true
HDB_combine_7bi_primschool <- 
  read_rds("data/rds/HDB_combine_7bi_primschool.rds")
kable(head(HDB_combine_7bi_primschool, 3))
```

## MRT

Within 500 meters

```{r}
#| code-fold: true
#| eval: false
within_500m_mrt <- st_is_within_distance(
  HDB_data, mrt_data, dist = 500)

HDB_combine_7bi_mrt <- HDB_combine_7bi_primschool %>%
  mutate(
    WITHIN_500m_MRT_BINARY = as.numeric(lengths(within_500m_mrt) > 0)
)
write_rds(HDB_combine_7bi_mrt, "data/rds/HDB_combine_7bi_mrt.rds")
```

```{r}
#| code-fold: true
HDB_combine_7bi_mrt <- read_rds("data/rds/HDB_combine_7bi_mrt.rds")
kable(head(HDB_combine_7bi_mrt, 3))
```

## Hawker centre

Within 500 meters

```{r}
#| code-fold: true
#| eval: false
within_500m_hkcenter <- st_is_within_distance(
  HDB_data, hkcenter_data, dist = 500)

HDB_combine_7bi_hkcenter <- HDB_combine_7bi_mrt %>%
  mutate(
    WITHIN_500m_HKC_BINARY = as.numeric(lengths(within_500m_hkcenter) > 0)
)
write_rds(HDB_combine_7bi_hkcenter, "data/rds/HDB_combine_7bi_hkcenter.rds")
```

```{r}
#| code-fold: true
HDB_combine_7bi_hkcenter <- read_rds("data/rds/HDB_combine_7bi_hkcenter.rds")
kable(head(HDB_combine_7bi_hkcenter, 3))
```
:::

### 2.4 Amenity Density Analysis

We would like to compute the amenity density with the number of location factors within a designated distance. `map_int()` of [**purr**]{style="color: #F08787;"} package is used to the number of preschools found in the newly created `WITHIN_[distance]_[amenity]` field.

::: panel-tabset
## kindergarten

Kindergartens within 350m of the HDB unit.

```{r}
#| code-fold: true
#| eval: false
within_350m_kindg <- st_is_within_distance(
  HDB_data, kindergarten_data, dist = 350)

HDB_combine_8dense_kindg <- HDB_combine_7bi_hkcenter %>%
  mutate(
    WITHIN_350m_KINDG = map_int(within_350m_kindg, length)
)
write_rds(HDB_combine_8dense_kindg, "data/rds/HDB_combine_8dense_kindg.rds")
```

```{r}
#| code-fold: true
HDB_combine_8dense_kindg <- read_rds("data/rds/HDB_combine_8dense_kindg.rds")
kable(head(HDB_combine_8dense_kindg, 3))
```

## childcare

Childcares within 350m of the HDB unit.

```{r}
#| code-fold: true
#| eval: false
within_350m_childc <- st_is_within_distance(
  HDB_data, preschool_data, dist = 350)

HDB_combine_8dense_childc <- HDB_combine_8dense_kindg %>%
  mutate(
    WITHIN_350m_CHILDC = map_int(within_350m_childc, length)
)
write_rds(HDB_combine_8dense_childc, "data/rds/HDB_combine_8dense_childc.rds")
```

```{r}
#| code-fold: true
HDB_combine_8dense_childc <- read_rds("data/rds/HDB_combine_8dense_childc.rds")
kable(head(HDB_combine_8dense_childc, 3))
```

## bus stop

Bus stops within 350m of the HDB unit.

```{r}
#| code-fold: true
#| eval: false
within_350m_bus <- st_is_within_distance(
  HDB_data, bus_data, dist = 350)

HDB_combine_8dense_bus <- HDB_combine_8dense_childc %>%
  mutate(
    WITHIN_350m_BUS = map_int(within_350m_bus, length)
)
write_rds(HDB_combine_8dense_bus, "data/rds/HDB_combine_8dense_bus.rds")
```

```{r}
#| code-fold: true
HDB_combine_8dense_bus <- read_rds("data/rds/HDB_combine_8dense_bus.rds")
kable(head(HDB_combine_8dense_bus, 3))
```

## primary school

Kindergartens within 1km of the HDB unit. We use 1km because housing within 1km of a primary school gets the priority of entolment. This is an important factor for some parents to look for (new) housing due to children education planning.

```{r}
#| code-fold: true
#| eval: false
within_1km_primsch <- st_is_within_distance(
  HDB_data, primschool_data, dist = 1000)

HDB_combine_8dense_primsch <- HDB_combine_8dense_bus %>%
  mutate(
    WITHIN_1km_PRISCH = map_int(within_1km_primsch, length)
)

write_rds(HDB_combine_8dense_primsch, "data/rds/HDB_combine_8dense_primsch.rds")
```

```{r}
#| code-fold: true
HDB_combine_8dense_primsch <- read_rds("data/rds/HDB_combine_8dense_primsch.rds")
kable(head(HDB_combine_8dense_primsch, 3))
```
:::

### 2.5 Final Dataset Assembly

#### **2.5.1 Save the master dataset**

With each data processing step in section 2.3 and 2.4, we have assembled all structural and location factors into the dataset *HDB_combine_8dense_primsch*. Below code we removed *remaining_lease_mths* because it has been converted to a new variable in months *remaining_lease_mths_num*.

```{r}
#| code-fold: true
#| eval: false

HDB_master <- HDB_combine_8dense_primsch %>%
  select(-remaining_lease_mths)

write_rds(HDB_master, "data/rds/HDB_master.rds")

```

```{r}
#| echo: false
HDB_master <- read_rds("data/rds/HDB_master.rds")
glimpse(HDB_master)
```

#### **2.5.2 Handle remaining missing values**

After data assembly, let's check if there is any missing values from the master dataset. The result **FALSE** indicates that there is no missing value.

```{r}
anyNA(HDB_master)
```

## 3 Data Quality & Spatial Overview

### 3.1 Data Quality Check

Let's run a summary statistics to examine is there is any obvious anomaly or outliers. From below results, there is no obvious anomaly detected. Just an interesting fact that the childcare service density could be up to 35 within 350m of range.

```{r}
summary(HDB_master)
```

### 3.2 Target Variable Analysis

Before we start data set preparation for predictive modeling training, we would like to leverage visualisations to observe the location factors and structural factors, and further examine if there are any anomalies.

```{r}
names(HDB_master)
```

#### **3.2.1 Plot distribution of variables**

::: panel-tabset
## Price distribution

The resale prices concentrate on 700,000 and is right skewed, indicating that there are many above 1 million dollar housing and even some outliers pricing crossing 1.2 million dollars.

```{r}
#| code-fold: true

ggplot(HDB_master, 
       aes(x = resale_price)) + 
  geom_histogram(bins = 30, color = "#F0F0F0", fill = "#B3C8CF") +
  labs(
    title = "Distribution of resale prices: HDB 4-room",
    subtitle = "(July 2024 - Sep 2025)",
    x = "Resale price S$",
    y = "Count",
    colour = "Gears") +
  theme(panel.background = element_rect(color = "white"),
        plot.background = element_rect(fill = "#EEEEEE")) 

```

## Price x Proximity

Most facilities show a downward trend in resale price as proximity to the facilities increases, such as clinics, MRT stations, parks, etc. Among these, CBD and top primary schools show the most obvious trends, while supermarkets and community centers show less obvious patterns. Interestingly, sports halls show a downward trend for shorter distances. However, after a distance of 1km, the trend reverses and prices begin to trend upward. Based on these observations, these variables will be retained as predicting factors in the model.

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 12
HDB_master_long <- HDB_master %>%
  pivot_longer(cols = c(PROX_TOPSCHOOL, PROX_HKCENTER, PROX_CLINIC, 
                        PROX_MALLS, PROX_CC, PROX_MRT, PROX_SUPERMKT, 
                        PROX_ELDERCARE, PROX_SPORTS, PROX_PARK,
                        PROX_CBD),
               names_to = "facility",
               values_to = "proximity")

ggplot(HDB_master_long, aes(x = proximity, y = resale_price)) +
  geom_point(alpha = 0.1, size = 0.4, colour = "#B3C8CF") +
  geom_smooth(method = "lm", color = "#FF8282", se = FALSE) +
  facet_wrap(~ facility, ncol = 3, scales = "free_x") +
  labs(x = "Proximity (m)", y = "Resale Price ($)",
       title = "HDB Resale Price vs Proximity to Facilities") +
  theme(panel.background = element_rect(color = "white"),
        plot.background = element_rect(fill = "#EEEEEE"),
        strip.text = element_text(size = 15),
        plot.title = element_text(size = 22),      
        axis.title = element_text(size = 15),
        axis.text.x = element_text(size = 11),
        axis.text.y = element_text(size = 11))
```

## Price x Facility density

The boxplots indicate that facility density variables exhibit varying relationships with HDB resale prices. Top primary schools and kindergartens demonstrate positive trends, whereas facilities like bus stops and primary schools show less pronounced associations.

Despite these varying patterns, all density variables were retained as potential predictors given their theoretical relevance to housing valuation.

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 10

HDB_master_long_dist <- HDB_master %>%
  pivot_longer(cols = c(WITHIN_1km_TOPPRISCH,
                        WITHIN_350m_BUS, WITHIN_350m_KINDG,
                        WITHIN_350m_CHILDC, WITHIN_1km_PRISCH),
               names_to = "facility_dist",
               values_to = "count") 

# Violin plot with boxplot inside
ggplot(HDB_master_long_dist, aes(x = factor(count), y = resale_price)) +
  geom_boxplot(width = 0.1, fill = "white", outlier.size = 0.5) +
  facet_wrap(~ facility_dist, ncol = 2, scales = "free_x") +
  labs(x = "Number of Facilities within distance",
       y = "Resale Price ($)",
       title = "HDB Resale Price Distribution by Facility Density") +
  theme(panel.background = element_rect(color = "white"),
        plot.background = element_rect(fill = "#EEEEEE"),
        strip.text = element_text(size = 15),
        plot.title = element_text(size = 22),      
        axis.title = element_text(size = 15),
        axis.text.x = element_text(size = 11),
        axis.text.y = element_text(size = 11))
```

## Price x Availability

The availability of top primary schools within 1km, hawker centers within 500m, and MRT stations within 500m show similar patterns in the boxplots. Suggests that the presence of these facilities could be a driver for HDB resale pricing. Interestingly, the absence of these facilities results in resale prices constrained within a narrower range compared to cases where these facilities are present, although numerous outliers are observed in both groups.

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 4

HDB_master_long_binary <- HDB_master %>%
  pivot_longer(cols = c(WITHIN_1km_TOPPRISCH_BINARY, WITHIN_500m_MRT_BINARY,
                        WITHIN_500m_HKC_BINARY),
               names_to = "facility_binary",
               values_to = "count") 

# Violin plot with boxplot inside
ggplot(HDB_master_long_binary, aes(x = factor(count), y = resale_price)) +
  geom_boxplot(width = 0.1, fill = "white", outlier.size = 0.5) +
  facet_wrap(~ facility_binary, ncol = 3, scales = "free_x") +
  labs(x = "Availability of Facilities within distance",
       y = "Resale Price ($)",
       title = "HDB Resale Price Distribution by Facility Availability") +
  theme(panel.background = element_rect(color = "white"),
        plot.background = element_rect(fill = "#EEEEEE"),
        strip.text = element_text(size = 15),
        plot.title = element_text(size = 22),      
        axis.title = element_text(size = 15),
        axis.text.x = element_text(size = 11),
        axis.text.y = element_text(size = 11))
```
:::

#### **3.2.2 Visualise HDB units prices on thematic map**

```{r}
names(HDB_master)
```

```{r}
#| fig-width: 12
#| fig-height: 8
#| code-fold: true

#tmap_mode("view")
tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.5,
          col = NA,
          fill_alpha = 0.7,
          fill.scale = tm_scale_continuous(values = "brewer.reds"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 1.2,      
          text.size = 1),
          ) +  
  
  tm_title(text = "HDB Resale Prices (2024-2025)")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.text.size = 0.7,             
    legend.title.size = 1,                
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "#EEEEEE",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
tmap_mode("plot")
```

::::: markgoals
::: markgoals-header
**Observation**
:::

::: markgoals-container
The thematic map reveals that HDB resale prices are generally higher closer to the city center, demonstrating a clear distance-decay pattern from the CBD. However, substantial price variation exists within all regions, ranging from low to high values. Also note that spatial clusters of high-priced units appear in certain mature estates despite their distance from the CBD, while some peripheral areas show unexpectedly elevated prices. This spatial heterogeneity suggests that locational factors (such as proximity to MRT stations and top primary schools) and structural characteristics (such as age) interact to influence pricing patterns across different neighborhoods.
:::
:::::

#### **3.2.3 Spatial Visualization of Amenities**

Below are thematic maps of amenity variables reveal varied spatial patterns across Singapore. These visualisations suggest spatial heterogeneity in the distribution of amenities and housing attributes; altogether supporting the need for spatial analytical approaches in modeling HDB resale prices.

::: panel-tabset
## Education

[**Primary schools (top 20 highlighted**)]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.6,
          fill_alpha = 0.4,
          col = "grey",
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +    
    
  tm_title(text = "HDB Resale Prices vs Top Primary schools")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
tmap_mode("plot")
```

[**Kindergartens**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(kindergarten_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +   
    
  tm_title(text = "HDB Resale Prices vs Kindergartens")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Childcare centres**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(preschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +   
    
  tm_title(text = "HDB Resale Prices vs Childcare centres")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

## Transport

[\*\*MRT station exits\*\*]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +   
    
  tm_title(text = "HDB Resale Prices vs MRT station exits")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Bus stops**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +    
  
  tm_title(text = "HDB Resale Prices vs Bus stops")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

## Commercial

[**Shopping malls**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +   
  
  tm_title(text = "HDB Resale Prices vs Malls")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Hawker centres**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.3, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +    
  
  tm_title(text = "HDB Resale Prices vs Hawkers")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Supermarkets**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(top_primschool_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +    
  
  tm_title(text = "HDB Resale Prices vs Supermarkets")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

## Business

[**CBD**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8
map_cbd <- tm_shape(mpsz) + 
  tm_polygons(
    fill = "REGION_N", col = "white", lwd = 0.8,
    fill.scale = tm_scale_categorical(
      values = c("#FFC4C4", "#87BAC3", "#8FABD4", "#FDE7B3", "#FDCFFA")
    ),
  fill_alpha = 0.4) +
  tm_shape(cbd_data) +
  tm_polygons(col = "red", col_alpha = 0.8, lwd = 2) + 
  
  tm_shape(HDB_master) +
  tm_dots(col = "PROX_CBD", 
          size = 0.2,             
          palette = "-RdYlBu",     
          alpha = 0.5) +

  tm_title(text = "HDB Resale Prices vs CBD")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )

map_cbd

```

[**Business parks**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(bizpark_data) +
  tm_dots(fill = "#FE7743", size = 0.3) +    
  
  tm_title(text = "HDB Resale Prices vs Business parks")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

## Recreation & Others

[**Parks**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(park_data) +
  tm_dots(fill = "#FE7743", size = 0.2) +    
  
  tm_title(text = "HDB Resale Prices vs Parks")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Sports halls**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(sports_data) +
  tm_dots(fill = "#FE7743", size = 0.2) +    
  
  tm_title(text = "HDB Resale Prices vs Sports halls")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

## Healthcare

[**Clinics**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(clinics_data) +
  tm_dots(fill = "#FE7743", size = 0.2) +    
  
  tm_title(text = "HDB Resale Prices vs Clinics")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```

[**Eldercare services**]{style="color: #F08787;"}

```{r}
#| code-fold: true
#| fig-width: 12
#| fig-height: 8

tm_shape(mpsz) + 
  tm_polygons(fill = "REGION_N", col = "white", lwd = 0.8, 
              fill_alpha = 0.4, fill.legend = tm_legend(show = FALSE),
              fill.scale = tm_scale_categorical(
                values = c("#FFC4C4", "#87BAC3", "#8FABD4", 
                           "#FDE7B3", "#FDCFFA"))) +
  
  tm_shape(HDB_master) +
  tm_dots(fill = "resale_price",
          size = 0.3,
          fill_alpha = 0.5,
          fill.scale = tm_scale_continuous(values = "brewer.blues"),
          fill.legend = tm_legend(title = "Resale Price ($)",
          title.size = 0.7,      
          text.size = 0.6),
          ) +  
  
  tm_shape(eldercare_data) +
  tm_dots(fill = "#FE7743", size = 0.2) +    
  
  tm_title(text = "HDB Resale Prices vs Eldercare services")+
  tm_layout(
    legend.position = c("right", "bottom"),  
    legend.bg.alpha = 0,
    outer.margins = 0,
    inner.margins = c(0.1, 0.1, 0.1, 0.1), 
    bg.color = "white",
    outer.bg.color = "#EEEEEE",
    frame = TRUE,
    frame.color = "white",
    frame.alpha = 0.3
  )
```
:::

## 4 Pre-modeling Preparation

### 4.1 Preparing Data

For this study, we will divide the entire dataset of `HDB_master` during the period of July 2024 to September 2025 into 2 sets. The training data (Jul 2024 - June 2025) and testing data (July - Sep 2025).

#### **4.1.1 Split data for train/test data**

```{r}
glimpse(HDB_master)
```

We also use `st_jutter()` to move the point features by 1m to avoid overlapping point features.

```{r}
#| eval: false
#| code-fold: true
HDB_master_jitter <- HDB_master %>%
  st_jitter(amoun = 1)

write_rds(HDB_master_jitter, "data/rds/HDB_master_jitter.rds")
```

```{r}
#| eval: false
#| code-fold: true
set.seed(1234)
HDB_train <- HDB_master_jitter %>%
  filter(transact_date >= "2024-07-01" & transact_date <= "2025-06-01") 

HDB_test <- HDB_master_jitter %>%
  filter(transact_date >= "2025-07-01" & transact_date <= "2025-09-01")

write_rds(HDB_train, "data/rds/HDB_train.rds")
write_rds(HDB_test, "data/rds/HDB_test.rds")
```

```{r}
#| echo: false
HDB_train <- read_rds("data/rds/HDB_train.rds")
HDB_test <- read_rds("data/rds/HDB_test.rds")
```

#### **4.1.2 Sample train data**

We will sample 5,000 data sets for predictive modeling training.

```{r}
set.seed(1234)
HDB_train_5k <- HDB_train %>%
  sample_n(5000)
```

### 4.2 Multicollinearity Check

#### **4.2.1 Correlation Matrix**

First we need to do a multicollinearity analysis on the predictors. We will create a correlatiom matrix. In this step, we are using this as EDA to explore the data.

```{r}
#| fig-width: 12
#| fig-height: 9
#| code-fold: true
par(bg = "#EEEEEE",
    mar = c(0.5, 0.5, 0.5, 0.5)) 
corrplot(cor(st_drop_geometry(HDB_train_5k)[, c(2, 3, 5, 7, 8:28)]),
         diag = FALSE, 
         order = "AOE",
         tl.pos = "td", 
         tl.cex = 1, 
         tl.srt = 40, 
         tl.col = "#3A6F43",
         number.cex = 0.7,
         method = "number", 
         type = "upper",
         bg = "#C5C7BC",
         addgrid.col = "#EEEEEE")         
```

::::: markgoals
::: markgoals-header
**Note**
:::

::: markgoals-container
-   From the scatterplot matrix, it is clear that *WITHIN_1km_TOPSCH* is highly correlated to *WITHIN_1km_TOPSCH_BINARY*. In addition, other pairs of variables *PROX_TOPSCHOOL* & *PROX_CBD*, *age* & *remaining_lease_mths_num*, *PROX_MRT* & *WITHIN_500m_MRT_BINARY* are also highly correlated (\>0.8 or near 0.8).
-   In view of this, it is wiser to only include either one of them in the subsequent model building. As a result, ***WITHIN_1km_TOPPRISCH***, ***age***, ***WITHIN_500m_MRT_BINARY*** and ***PROX_TOPSCHOOL*** are excluded in the subsequent model building.

```{r}
#| eval: false
#| code-fold: true

train_data_corr <- HDB_train_5k %>%
  select(-WITHIN_1km_TOPPRISCH,
         -age,
         -WITHIN_500m_MRT_BINARY,
         -PROX_TOPSCHOOL)

test_data_corr <- HDB_test %>%
  select(-WITHIN_1km_TOPPRISCH,
         -age,
         -WITHIN_500m_MRT_BINARY,
         -PROX_TOPSCHOOL)

write_rds(train_data_corr, "data/rds/train_data_corr.rds")
write_rds(test_data_corr, "data/rds/test_data_corr.rds")
```

```{r}
#| echo: false
train_data_corr <- read_rds("data/rds/train_data_corr.rds")
test_data_corr <- read_rds("data/rds/test_data_corr.rds")
```
:::
:::::

#### **4.2.2 Initial Models**

After collinearity check, we directly removed the highly correlated variables from the datasets. Next we will perform VIF check. A high VIF indicates that a particular predictor variable is highly correlated with other predictors in the model, which can inflate the variance of its coefficient, leading to unstable and unreliable results.

Therefore, we will check VIF before building the models, using the remaining variables below:

```{r}
#| echo: false

names(train_data_corr)[3:25]
```

Below we will start the VIF iteration. For each VIF iteration, we will check the VIF scores, and remove the highest to perform the next iteration until there is no high VIF scores \> 10.

::: panel-tabset
## VIF1

```{r}
#| code-fold: true
#| eval: false
# Build initial model with all variables
initial_mlr1 <- lm(
  formula = resale_price ~ 
    floor_level + plan_area + floor_area_sqm + flat_model + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT + PROX_CLINIC + PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_PARK + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_corr)
write_rds(initial_mlr1, "data/rds/initial_mlr1.rds")
```

```{r}
#| echo: false
initial_mlr1 <- read_rds("data/rds/initial_mlr1.rds")
summary(initial_mlr1)
```

## VIF2

In the 2nd iteration, we will remove the highest VIF *plan_area*.

```{r}
#| code-fold: true
#| eval: false
initial_mlr2 <- lm(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + flat_model + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT + PROX_CLINIC + PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_PARK + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_corr)
write_rds(initial_mlr2, "data/rds/initial_mlr2.rds")

```

```{r}
#| echo: false
initial_mlr2 <- read_rds("data/rds/initial_mlr2.rds")
summary(initial_mlr2)
```

## VIF3

In the 3rd iteration, we will remove the highest VIF *flat_model* (10.98).

```{r}
#| code-fold: true
#| eval: false
# Build initial model with all variables
initial_mlr3 <- lm(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT + PROX_CLINIC + PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_PARK + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_corr)

write_rds(initial_mlr3, "data/rds/initial_mlr3.rds")

```

```{r}
#| echo: false
initial_mlr3 <- read_rds("data/rds/initial_mlr3.rds")
summary(initial_mlr3)
```
:::

**Check for multicollinearity and plot VIF scores**

::: panel-tabset
## VIF1

Based on the following VIF scores, 4 variables are in the High Correlation category, with *plan_area* of 1.20e+05 being the highest.

```{r}
#| code-fold: true
check_collinearity(initial_mlr1)
```

```{r}
#| code-fold: true
#| align: center
mlr1.vif <- check_collinearity(initial_mlr1)
plot(mlr1.vif) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "#EEEEEE", color = NA),
    panel.background = element_rect(fill = "gray95", color = NA),
    axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1, size = 5)
  )
```

## VIF2

After removing *plan_area* from VIF1, 1 variable remains in the High Correlation category, with *flat_model* of 10.98 being the highest.

```{r}
#| code-fold: true
check_collinearity(initial_mlr2)
```

```{r}
#| code-fold: true
#| align: center
mlr2.vif <- check_collinearity(initial_mlr2)
plot(mlr2.vif) +
    theme_minimal() +
  theme(
    plot.background = element_rect(fill = "#EEEEEE", color = NA),
    panel.background = element_rect(fill = "gray95", color = NA),
    axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1, size = 5)
  )
```

## VIF3

At the 3rd iteration, we see all remaining variables are all low correlated.

```{r}
#| code-fold: true
check_collinearity(initial_mlr3)
```

```{r}
#| code-fold: true
#| align: center
mlr3.vif <- check_collinearity(initial_mlr3)
plot(mlr3.vif) +
  theme_minimal() +
  theme(
    plot.background = element_rect(fill = "#EEEEEE", color = NA),
    panel.background = element_rect(fill = "gray95", color = NA),
    axis.text.x = element_text(angle = 35, hjust = 1, vjust = 1, size = 5)
  )
```
:::

### 4.3 Feature Selection

**Final feature list for modeling**

After 3 iterations of removing high VIF variables, all VIF are now below 10. So we can conclude that there are no sign of multicollinearity among the independent variables.

Based on the multicollinearity measuring results from VIF3, we find that some variables are not statistically significant, including *PROX_CLINIC* and *PROX_PARK*. We will revise the initial model by removing these 2 variables.

**Total original dataset size**

Total original dataset size was 14,737 observations, and we divided them into train set from July 2024 to June 2025 and test set from July - Sep 2025. Among 11,680 data sets during July 2024 - June 2025, we also have randomly sampled 5,000 just for training data to calibrate the machine learning models properly.

The rest of 3,057 obervations from July - September 2025 are test data for predictions.

## [PREDICTIVE MODELING]{style="color: #E45A92;"}

From section 5 to 6, we will calibrate 4 predictive modeling for HDB resale price using the same set of variables for a comparison and then predict the prices using the test data. The models include Multi Linear Regression model (MLR), Geographycally Weighed Regression (GWR) model, Non-spatial Random Forest model, as well as Geographical Weighted Random Forest (gwRF) model.

## 5 Model Calibration

::: panel-tabset
## 5.1 MLR

### **5.1.1 Model calibration**

Multiple Linear Regression Building upon the initial MLR model from section 4.2.2, we calibrate the revised MLR model as below. *PROX_CLINIC* and *PROX_PARK* will be removed.

```{r}
#| eval: false
#| code-fold: true
hdb.mlr <- lm(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_corr)
write_rds(hdb.mlr, "data/rds/hdb.mlr")

```

```{r}
#| echo: false
hdb.mlr <- read_rds("data/rds/hdb.mlr")
summary(hdb.mlr)
```

The output above reveals that all explanatory variables are statistically significant at 95% confident level.

### **5.1.2 MLR Model calibration result**

We use `tbl_regression()` to create a regression report for MLR.

```{r}
#| code-fold: true
tbl_regression(hdb.mlr, 
               intercept = TRUE) %>% 
  add_glance_source_note(
    label = list(sigma ~ "\U03C3"),
    include = c(r.squared, adj.r.squared, 
                AIC, statistic,
                p.value, sigma)) %>%
  modify_table_styling(
    columns = label,
    rows = variable %in% c("flat_type", "floor_range"),
    footnote = "Categorical variable"
  ) %>%
  bold_labels()
```

## 5.2 GWR

We will use Geographically Weighted Regression to build a Hedonic Pricing Model in this section.

### **5.2.1 Bandwidth selection**

Adaptive bandwidth is the chosen approach for the GWR modeling as Singapore has varying spatial density of the housing.

Below we will use Cross Validation (CV) approach to compuete the Bandwidth:

The result below shows that the **48 is the recommended data points** to be used.

```{r}
#| eval: false
#| code-fold: true
bw.adaptive <- bw.gwr(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data=train_data_corr, 
  approach="CV", 
  kernel="gaussian", 
  adaptive=TRUE, 
  longlat=FALSE)

write_rds(bw.adaptive, "data/rds/bw.adaptive.rds")
```

```{r}
#| echo: false
bw.adaptive <- read_rds("data/rds/bw.adaptive.rds")
```

### **5.2.2 Model calibration**

Now we will calibrate the GWR-based hedonic pricing model using the adaptive bandwidth from section 5.2.1 and gaussian kernel.

```{r}
#| eval: false
#| code-fold: true
gwr.adaptive <- gwr.basic(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_corr, 
  bw = bw.adaptive, 
  kernel = 'gaussian', 
  adaptive=TRUE, 
  longlat = FALSE)

write_rds(gwr.adaptive, "data/model/gwr.adaptive.rds")
```

### **5.2.3 GRW Model calibration**

```{r}
#| echo: false
gwr.adaptive <- read_rds("data/model/gwr.adaptive.rds")
gwr.adaptive
```

## 5.3 RF

In this section, we want to calibrate a model to predict HDB resale price using the Random Forest method.

### **5.3.1 Data preparation**

First is to **extract the x, y coordinates** of the training and test data sets.

```{r}
#| eval: false
#| code-fold: true
coords <- st_coordinates(HDB_master_jitter)
coords_train <- st_coordinates(train_data_corr)
coords_test <- st_coordinates(test_data_corr)

write_rds(coords_train, "data/rds/coords_train.rds")
write_rds(coords_test, "data/rds/coords_test.rds")
```

```{r}
#| echo: false
coords_train <- read_rds("data/rds/coords_train.rds")
coords_test <- read_rds("data/rds/coords_test.rds")
```

**Drop geometry field**

```{r}
train_data_nogeom <- train_data_corr %>%
  st_drop_geometry()

test_data_nogeom <- test_data_corr %>%
  st_drop_geometry()

```

### **5.3.2 Calibrate non-spatial RF model with** `ranger()`

```{r}
#| eval: false
#| code-fold: true

set.seed(1234)
rf <- ranger(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data = train_data_nogeom
)

write_rds(rf, "data/model/rf.rds")
```

### **5.3.3 RF Model calibration**

```{r}
#| echo: false
rf <- read_rds("data/model/rf.rds")
rf
```

## 5.4 GWRF

In this section, we will calibrate Geographical Weighted Random Forest Model with the training data.

### **5.4.1 Bandwidth selection**

We will use GWR Bandwidth for GWRF: `bw.adaptive`.

### **5.4.2 Model calibration**

```{r}
#| eval: false
#| code-fold: true

set.seed(1234)
gwRF_adaptive <- grf(
  formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  dframe = train_data_nogeom, 
  bw = bw.adaptive,
  kernel = "adaptive",
  coords = coords_train,
  ntree = 500,
  mtry = 3)

write_rds(gwRF_adaptive, "data/model/gwRF_adaptive.rds")

```

### **5.4.3 gwRF Model calibration result**

```{r}
#| code-fold: true
gwRF_adaptive <- read_rds("data/model/gwRF_adaptive.rds")
gwRF_adaptive$LocalModelSummary
```
:::

## 6 Predictions with Test Data

::: panel-tabset
## 6.1 MLR

### **6.1.1 Predict with test data**

```{r}
#| eval: false
#| code-fold: true
mlr_pred <- predict(hdb.mlr, newdata = test_data_corr)
write_rds(mlr_pred, "data/model/mlr_pred.rds")
```

### **6.1.2 Append predicted values to the test dataset**

```{r}
#| code-fold: true
mlr_pred <- read_rds("data/model/mlr_pred.rds")

test_data_p_mlr <- test_data_corr %>%
  mutate(mlr_pred = mlr_pred)

kable(head(test_data_p_mlr))
```

### **6.1.3 Calculate performance metrics**

Calculate RMSE, MAE and R\^2 metrics

```{r}
#| code-fold: true
# RMSE
rmse_mlr <- sqrt(mean((test_data_p_mlr$resale_price - test_data_p_mlr$mlr_pred)^2))

# MAE
mae_mlr <- mean(abs(test_data_p_mlr$resale_price - test_data_p_mlr$mlr_pred))

# R^2
ss_res <- sum((test_data_p_mlr$resale_price - test_data_p_mlr$mlr_pred)^2)
ss_tot <- sum((test_data_p_mlr$resale_price - mean(test_data_p_mlr$resale_price))^2)
r2_mlr <- 1 - (ss_res / ss_tot)

cat("MLR RMSE:", format(rmse_mlr), "\n",
    "MLR MAE:", format(mae_mlr), "\n",
    "MLR R^2:", round(r2_mlr, 4))
```

### **6.1.4 Visualising the predicted values**

```{r}
#| code-fold: true
p1 <- ggplot(data = test_data_p_mlr,
       aes(x = mlr_pred,
           y = resale_price,
           text = paste("Actual: $", format(resale_price, big.mark = ","),
                       "\nPredicted: $", format(mlr_pred, big.mark = ","),
                       "\nError: $", format(resale_price - mlr_pred, big.mark = ","),
                       sep = ""))) +           
  geom_point(col = "#EF7722", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, 
              color = "#DC143C", linetype = "dashed", linewidth = 1) +  
  labs(title = "MLR: Predicted vs Actual Resale Prices",
       x = "Predicted Resale Price (S$)",
       y = "Actual Resale Price (S$)") +
    theme_minimal() +  
  theme(
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
  )  
ggplotly(p1, tooltip = "text")

```

MLR predictions quite largely deviate from the actual prices, especially for higher quantums beyond \$900,000.

## 6.2 GWR

### **6.2.1 Compute predicted values**

```{r}
#| eval: false
#| code-fold: true

gwr_pred <- gwr.predict(
  formula = resale_price ~
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
  data=train_data_corr, 
  predictdata = test_data_corr, 
  bw=bw.adaptive, 
  kernel = 'gaussian', 
  adaptive=TRUE, 
  longlat = FALSE)

write_rds(gwr_pred, "data/model/gwr_pred.rds")
```

```{r}
#| echo: false

gwr_pred <- read_rds("data/model/gwr_pred.rds")
```

### **6.2.2 Append predicted values to the test dataset**

Below is to append the predicted values using GWR moderling to the test dataset. You will see the first few rows of the result.

```{r}
#| code-fold: true
gwr_predictions <- gwr_pred$SDF$prediction

test_data_p <- test_data_p_mlr
test_data_p$gwr_pred <- gwr_predictions

kable(head(test_data_p[, c("resale_price", "gwr_pred")]))
```

### **6.2.3 GWR Model performance metrics**

To assess GWR modeling performance, we will obtain the performance metrics Root Mean Squared Error (RMSE), Mean Absolute Error (MAE) and R square metrics.

```{r}
#| code-fold: true
#| eval: false
# RMSE
gwr_rmse <- sqrt(mean((test_data_p$resale_price - test_data_p$gwr_pred)^2))

# MAE
gwr_mae <- mean(abs(test_data_p$resale_price - test_data_p$gwr_pred))

# R-squared
gwr_rsq <- cor(test_data_p$resale_price, test_data_p$gwr_pred)^2

write_rds(gwr_rmse, "data/rds/gwr_rmse.rds")
write_rds(gwr_mae, "data/rds/gwr_mae.rds")
write_rds(gwr_rsq, "data/rds/gwr_rsq.rds")

```

```{r}
#| code-fold: true
#| echo: true

gwr_rmse <- read_rds("data/rds/gwr_rmse.rds")
gwr_mae <- read_rds("data/rds/gwr_mae.rds")
gwr_rsq <- read_rds("data/rds/gwr_rsq.rds")
  
print(paste("GWR RMSE:", round(gwr_rmse, 2)))
print(paste("GWR MAE:", round(gwr_mae, 2)))
print(paste("GWR R^2:", round(gwr_rsq, 4)))
```

### **6.3.4 Visualising the predicted values**

Let's visualise the actual resale price and the predicted resale price in the scatter plot.

```{r}
#| code-fold: true
p2 <- ggplot(data = test_data_p,
       aes(x = gwr_pred,
           y = resale_price,
           text = paste("Actual: $", format(resale_price, big.mark = ","),
                       "\nPredicted: $", format(gwr_pred, big.mark = ","),
                       "\nError: $", format(resale_price - gwr_pred, big.mark = ","),
                       sep = ""))) +           
  geom_point(col = "#8AA624", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, 
              color = "#DC143C", linetype = "dashed", linewidth = 1) +
  labs(title = "GWR: Predicted vs Actual Resale Prices",
       x = "Predicted Resale Price (S$)",
       y = "Actual Resale Price (S$)") +
    theme_minimal() +  
  theme(
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
  )  
  
ggplotly(p2, tooltip = "text")
```

The scatterplot demonstrates strong predictive performance, with points clustering tightly along the 45-degree line (perfect prediction). The majority of predictions fall within a narrow band around the diagonal, indicating minimal systematic bias. Even the outliers remain within ±\$150,000 of actual values. This tight concentration suggests the GWR model effectively captures the spatial variation in HDB pricing across Singapore's diverse regions.

## 6.3 RF

### **6.3.1 Predict with test data**

Mode

```{r}
#| eval: false
#| code-fold: true
rf_pred <- predict(
  rf, data = test_data_nogeom)

write_rds(rf_pred, "data/model/rf_pred.rds")
```

```{r}
#| echo: false
rf_pred <- read_rds("data/model/rf_pred.rds")
```

### **6.3.2 Append predicted values to the test dataset**

```{r}
#| code-fold: true
rf_predictions <- rf_pred$predictions

test_data_p$rf_pred <- rf_predictions

kable(head(test_data_p[, c("resale_price", "gwr_pred")]))
```

### **6.3.3 RF Model performance metrics**

```{r}
#| code-fold: true
#| eval: false
# RMSE
rf_rmse <- sqrt(mean((test_data_p$resale_price - test_data_p$rf_pred)^2))

# MAE
rf_mae <- mean(abs(test_data_p$resale_price - test_data_p$rf_pred))

# R^2
rf_rsq <- cor(test_data_p$resale_price, test_data_p$rf_pred)^2

write_rds(rf_rmse, "data/rds/rf_rmse.rds")
write_rds(rf_mae, "data/rds/rf_mae.rds")
write_rds(rf_rsq, "data/rds/rf_rsq.rds")
```

```{r}
#| code-fold: true
#| echo: false

rf_rmse <- read_rds("data/rds/rf_rmse.rds")
rf_mae <- read_rds("data/rds/rf_mae.rds")
rf_rsq <- read_rds("data/rds/rf_rsq.rds")

print(paste("RF RMSE:", rf_rmse))
print(paste("RF MAE:", rf_mae))
print(paste("RF R^2:", rf_rsq))
```

### **6.3.4 Visualising the predicted values**

Let's visualise the actual resale price and the predicted resale price in the scatter plot.

```{r}
#| code-fold: true
p3 <- ggplot(data = test_data_p,
       aes(x = rf_pred,
           y = resale_price,
           text = paste("Actual: $", format(resale_price, big.mark = ","),
                       "\nPredicted: $", format(rf_pred, big.mark = ","),
                       "\nError: $", format(resale_price - rf_pred, big.mark = ","),
                       sep = ""))) +           
  geom_point(col = "#3396D3", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, 
              color = "#DC143C", linetype = "dashed", linewidth = 1) +  
  labs(title = "RF: Predicted vs Actual Resale Prices",
       x = "Predicted Resale Price (S$)",
       y = "Actual Resale Price (S$)") +
    theme_minimal() +  
  theme(
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
  )  
  
ggplotly(p3, tooltip = "text")
```

RF predictions are generally decent as they are all quite close to the slope of 1. The model also tends to predict lower than the actual resale prices, but there are few outliers.

## 6.4 GWRF

### **6.4.1 Prepare test data**

```{r}
#| code-fold: true

test_data_gwrf <- cbind(
  test_data_corr, coords_test) %>%
  st_drop_geometry()

kable(head(test_data_gwrf))
```

### **6.4.2 gwRF Predict with test data**

Below prediction ran for 40 sec.

```{r}
#| eval: false
#| code-fold: true
gwRF_pred <- predict.grf(gwRF_adaptive,
                         test_data_gwrf,
                         x.var.name = "X",
                         y.var.name = "Y",
                         local.w = 1,
                         global.w = 0)

gwRF_pred <- write_rds(gwRF_pred, "data/model/gwRF_pred.rds")
```

```{r}
#| echo: false
gwRF_pred <- read_rds("data/model/gwRF_pred.rds")

```

### **6.4.3 Append predicted values to the test dataset**

```{r}
#| eval: false
#| code-fold: true

gwRF_pred_df <- as.data.frame(gwRF_pred)

test_data_p$gwrf_pred <- gwRF_pred_df[, 1]

write_rds(test_data_p, "data/rds/test_data_p.rds")

```

```{r}
#| echo: false
test_data_p <- read_rds("data/rds/test_data_p.rds")
kable(head(test_data_p))

```

### **6.4.4 gwRF Model performance metrics**

We calculate the root mean square error (RMSE) to measure how far predicted values are from observed values in a regression analysis.

```{r}
#| code-fold: true
#| eval: false
# RMSE

gwrf_rmse <- sqrt(mean((test_data_p$resale_price - test_data_p$gwrf_pred)^2))

# MAE
gwrf_mae <- mean(abs(test_data_p$resale_price - test_data_p$gwrf_pred))

# R^2
gwrf_rsq <- cor(test_data_p$resale_price, test_data_p$gwrf_pred)^2

write_rds(gwrf_rmse, "data/rds/gwrf_rmse.rds")
write_rds(gwrf_mae, "data/rds/gwrf_mae.rds")
write_rds(gwrf_rsq, "data/rds/gwrf_rsq.rds")
```

```{r}
#| code-fold: true
#| echo: false

gwrf_rmse <- read_rds("data/rds/gwrf_rmse.rds")
gwrf_mae <- read_rds("data/rds/gwrf_mae.rds")
gwrf_rsq <- read_rds("data/rds/gwrf_rsq.rds")

print(paste("gwRF MSE:", rf_rmse))
print(paste("gwRF MAE:", rf_mae))
print(paste("gwRF R^2:", rf_rsq))
```

### **6.4.5 Visualising the predicted values**

Let's visualise the actual resale price and the predicted resale price in the scatter plot.

```{r}
#| code-fold: true
p4 <- ggplot(data = test_data_p,
       aes(x = gwrf_pred,
           y = resale_price,
           text = paste("Actual: $", format(resale_price, big.mark = ","),
                       "\nPredicted: $", format(gwrf_pred, big.mark = ","),
                       "\nError: $", format(resale_price - gwrf_pred, big.mark = ","),
                       sep = ""))) +           
  geom_point(col = "#E45A92", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, 
              color = "#DC143C", linetype = "dashed", linewidth = 1) +   
  labs(title = "GWRF: Predicted vs Actual Resale Prices",
       x = "Predicted Resale Price (S$)",
       y = "Actual Resale Price (S$)") +
    theme_minimal() +  
  theme(
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
  )  
  
ggplotly(p4, tooltip = "text")
```

gwRF model predictions are mostly close to the actual resale prices, but it has many outliers that divate for almost 50,0000 (50%) higher than the actual prices.
:::

## 7 Model Evaluation

```{r}
#| fig-width: 10 
#| fig-height: 8
#| echo: false

# p1 <- ggplot(data = test_data_p_mlr,
#        aes(x = mlr_pred,
#            y = resale_price)) +
#   geom_point(col = "#EF7722", size = 0.5) +
#   geom_abline(intercept = 0, slope = 1, 
#               color = "#DC143C", linetype = "dashed", linewidth = 1) +
#   labs(title = "MLR: Predicted vs Actual Resale Prices",
#        x = "Predicted Resale Price (S$)",
#        y = "Actual Resale Price (S$)") +
#     theme_minimal() +  
#   theme(
#     plot.background = element_rect(fill = "#D0DDD0"),      
#     panel.background = element_rect(fill = "#F5F5F5"),   
#     plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
#   )  
# 
# p2 <- ggplot(data = test_data_p,
#        aes(x = gwr_pred,
#            y = resale_price)) +
#   geom_point(col = "#8AA624", size = 0.5) +
#   geom_abline(intercept = 0, slope = 1, 
#               color = "#DC143C", linetype = "dashed", linewidth = 1) +  
#   labs(title = "GWR: Predicted vs Actual Resale Prices",
#        x = "Predicted Resale Price (S$)",
#        y = "Actual Resale Price (S$)") +
#     theme_minimal() +  
#   theme(
#     plot.background = element_rect(fill = "#D0DDD0"),      
#     panel.background = element_rect(fill = "#F5F5F5"),   
#     plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
#   )  
# 
# p3 <- ggplot(data = test_data_p,
#        aes(x = rf_pred,
#            y = resale_price)) +
#   geom_point(col = "#3396D3", size = 0.5) +
#   geom_abline(intercept = 0, slope = 1, 
#               color = "#DC143C", linetype = "dashed", linewidth = 1) +
#   labs(title = "RF: Predicted vs Actual Resale Prices",
#        x = "Predicted Resale Price (S$)",
#        y = "Actual Resale Price (S$)") +
#     theme_minimal() +  
#   theme(
#     plot.background = element_rect(fill = "#D0DDD0"),      
#     panel.background = element_rect(fill = "#F5F5F5"),   
#     plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
#   )  
# 
# p4 <- ggplot(data = test_data_p,
#        aes(x = gwrf_pred,
#            y = resale_price)) +
#   geom_point(col = "#E45A92", size = 0.5) +
#   geom_abline(intercept = 0, slope = 1, 
#               color = "#DC143C", linetype = "dashed", linewidth = 1) +
#   labs(title = "GWRF: Predicted vs Actual Resale Prices",
#        x = "Predicted Resale Price (S$)",
#        y = "Actual Resale Price (S$)") +
#     theme_minimal() +  
#   theme(
#     plot.background = element_rect(fill = "#D0DDD0"),      
#     panel.background = element_rect(fill = "#F5F5F5"),   
#     plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
#   )  

(p1 | p2) / (p3 | p4)

```

### 7.1 Performance metrics (RMSE, MAE, R²)

Based on the scatterplots and the metrics result below, we can conclude that:

-   **Geographically Weighted Regression**

GWR demonstrates the strongest performance, with predictions clustering tightly along the 45-degree reference line and minimal systematic bias. Even outliers remain within ±\$150,000 of actual values, indicating the model effectively captures spatial variation across Singapore's diverse housing markets.

-   **Random Forest**

Random Forest shows generally good performance with most predictions close to the diagonal, though the model exhibits a slight tendency to underpredict for higher-priced units. Outliers are minimal and predictions maintain consistency across the price range.

-   **Multiple Linear Regression**

MLR shows the weakest performance, with predictions substantially deviating from actual prices, especially for premium units exceeding \$900,000. The scatter indicates systematic bias and inability to capture non-linear relationships in the data.

-   **Geographical Weighted Random Forest**

gwRF displays mixed results, with most predictions reasonably close to actual values but suffering from many significant outliers that overpredict by up to \$479,244 (approximately 50% error). This inconsistency suggests the model struggles with certain spatial or feature combinations.

```{r}
#| code-fold: true

model_comparison <- data.frame(
  Model = c("MLR", "GWR", "Random Forest", "gwRF"),
  RMSE = c(rmse_mlr, gwr_rmse, rf_rmse, gwrf_rmse),
  MAE = c(mae_mlr, gwr_mae, rf_mae, gwrf_mae),
  R_2 = c(r2_mlr, gwr_rsq, rf_rsq, gwrf_rsq)
)

datatable(model_comparison,
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE,
          class = 'cell-border stripe') %>%
  formatRound(columns = c('RMSE', 'MAE', 'R_2'), digits = 4) 
```

RMSE (Root Mean Squared Error) MAE (Mean Absolute Error) R² on test set Compare across all 4 models

### 7.2 Model comparison

Table from Section 7.1 is an interactive table that readers can sort the values in ascending or descending order for each metric.

The bar charts below helps decide that GWR is the winner among all 4 models across all 3 metrics, with the highest R² and lowest RMSE & MAE, followed by Random Forest, Geographical Weighted Random Forest and lastly Multilinear Regression.

-   **RMSE:** GWR \> RF \> geRF \> MLR
-   **MAE:** GWR \> RF \> geRF \> MLR
-   **R²:** GWR \> RF \> geRF \> MLR

```{r}
#| code-fold: true
# pivot longer
model_comparison_long <- model_comparison %>%
  pivot_longer(cols = c(RMSE, MAE, R_2),
               names_to = "metric",
               values_to = "value") %>%
  mutate(metric = recode(metric,
                         "R_2" = "R^2",
                         "RMSE" = "RMSE",
                         "MAE" = "MAE"))

# Create ordering within each metric
model_comparison_long <- model_comparison_long %>%
  group_by(metric) %>%
  mutate(
    sort_helper = if_else(metric %in% c("RMSE", "MAE"), value, -value),
    Rank = if_else(metric %in% c("RMSE", "MAE"), 
                   rank(value), 
                   rank(-value))    
  ) %>%
  arrange(metric, sort_helper) %>%  # Sort within each metric
  mutate(
    Model_metric = paste(Model, metric, sep = "___"),  # Create unique identifier
    Model_metric = factor(Model_metric, levels = unique(Model_metric))
  ) %>%
  ungroup()

p <- ggplot(model_comparison_long, 
       aes(x = Model_metric, y = value, fill = Model,
           text = paste0("<b>", Model, "</b>",
                        "\n", metric, ": ", format(round(value, 4), big.mark = ","),
                        "\nRank: ", Rank, " of 4"))) +            
  
  geom_bar(stat = "identity", alpha = 0.8) +
  facet_wrap(~ metric, scales = "free", ncol = 3) +
  scale_x_discrete(labels = function(x) gsub("___.*", "", x)) + 
  scale_fill_manual(values = c("MLR" = "#E2A16F", 
                                "GWR" = "#A6B28B", 
                                "Random Forest" = "#B2C6D5", 
                                "gwRF" = "#FFC6C6")) +
  labs(title = "Model Performance Comparison",
       x = "Model",
       y = "Value") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    strip.text = element_text(size = 11, face = "bold"),
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    panel.border = element_rect(color = "white", fill = NA, linewidth = 1),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
ggplotly(p, tooltip = "text")
```

### 7.3 Best model selection

-   **The best overall model**

These visual patterns confirm the quantitative metrics: **Geographically Weighted Regression (GWR)** achieves the most reliable predictions, followed by RF, while gwRF's outlier problem and MLR's systematic bias limit their practical utility.

It has the best performance across all metrics (Lowest RMSE = 38,028; Lowest MAE = 28,750; Highest R² = 0.9587). This demonstrates superior predictive accuracy for HDB resale prices.

-   **Spatial vs Non-Spatial models**

The results present an interesting finding: while GWR (spatial) outperforms all models, Random Forest outperforms Geographically Weighted Random Forest (spatial). This suggests that spatial heterogeneity matters, but its benefit depends on the modeling approach.

GWR's parametric framework effectively captures smooth spatial gradients in Singapore's housing market, while GWRF's localised tree-based partitioning may struggle with the continuous nature of spatial price variations. MLR's poor performance (RMSE = 51,438) confirms that a simple global model is insufficient for capturing Singapore's spatially complex housing dynamics.

-   **Computational trade-offs**

GWR requires significantly more computational resources, taking short time to train but 30-40 minutes to predict on 5,000 observations, as compared to negligible training and testing time for other models (tested on a high-specification laptop).

Despite this computational cost, GWR's superior accuracy justifies its use for applications prioritising prediction quality. For resource-constrained scenarios or applications requiring rapid retraining, Random Forest would provide a strong alternative with comparable performance (RMSE = 38,423) and minimal computational overhead.

## 8 Discussion & Conclusion

### 8.1 Key findings

The results reveal important insights about spatial modeling for HDB resale prices.

-   **Spatial heterogeneity is significant:**

GWR substantially outperformed all other models, achieving the lowest RMSE (38,028) and highest R² (0.9587). This demonstrates that locally-varying relationships between property characteristics and prices are crucial for accurate prediction in Singapore's HDB market.

Different neighborhoods exhibit different pricing dynamics that cannot be captured by global models. For Random Forest, despite its flexibility, its RMSE=41,950 could not match GWR's performance. While RF can learn complex patterns, it lacks the explicit spatial weighting mechanism that allows GWR to adapt coefficients by location. The 4,000 SGD difference in RMSE represents practically significant prediction error (\~10% improvement with GWR).

-   **Over-localisation problem in gwRF**

Adding spatial weighting to Random Forest actually degraded performance below standalone RF. With bandwidth=48 neighbors, each local RF seemed to train on insufficient data, leading to overfitting. We experimented with a hybrid approach (60% local, 40% global) partially recovered performance but still couldn't match either GWR or RF *(see Appendix)*.

-   **Model recommendations**

For best prediction accuracy: Use GWR. It provides superior performance and spatial interpretability

For computational efficiency: Use RF as a faster alternative with acceptable accuracy. It ran only for 1-3 seconds for this study.

Avoid fully local gwRF: due to overfitting and poor performance despite higher computational cost (than RF). We tested a hybrid gwRF approach to address potential over-localisation. While the hybrid model outperformed the fully local gwRF, it remained inferior to both GWR and standalone RF. This confirms that:

### 8.2 Future work

Both GWR and gwRF used an adaptive bandwidth of 48 neighbors, optimized using cross-validation for the GWR model. Future work could explore whether gwRF benefits from a larger bandwidth given the additional data requirements of ensemble methods.

These findings suggest that future research on spatial ensemble methods should focus on alternative approaches to incorporating spatial information—such as spatial features or constraints—rather than geographic weighting schemes that may conflict with the inherent spatial partitioning of tree-based models

::::: markgoals
::: markgoals-header
**Self Reflection**
:::

::: markgoals-container
Geospatial studies are very exciting because the methods and models allow us to discover tremendous insights for informing policies and business strategies. Through this assignment I learned to appreciate predictive modeling methodologies in the geospatial field. The finding is also quite interesting as it kind of goes against what I initially thought - GWR and gwRF must win. It came as a surprise that gwRF actually did not!

All the lessons covered help me realise that there are just yet a lot more to learn. I always find data so fascinating when I come to each of the lesson since Data Analytics Lab module. Sincere thanks to Prof. Kam's patience and encouragement on the assignments and answering questions, making the data analytics journey so amazing! Together with visual analytics, I have developed greater interest in these fields and will continue the journey. Hopefully I can really utilise the knowledge and skillset to do some good to the society.
:::
:::::

## 9 Reference

-   Kam, T. S. 2025. *R for Geospatial Data Science and Analytics*

-   Gangula, K. (n.d.). *Shopping mall coordinates* \[Data set\]. Kaggle. Retrieved November 9, 2025, from <https://www.kaggle.com/datasets/karthikgangula/shopping-mall-coordinates>

-   data.gov.sg. (2025). *multiple data sets* \[Data set\] (refer to section 2.1) Retrieved Nov 9, 2025, from <https://data.gov.sg/>

-   Land Transport (2025). *multiple data sets* \[Data set\] (refer to section 2.1). Retrieved Nov 9, 2025, from <https://datamall.lta.gov.sg/content/datamall/en.html>.

-   *Shopping mall.* (n.d.). In Wikipedia. Retrieved November 9, 2025, from https://en.wikipedia.org/wiki/Shopping_mall

-   Sophia Education. (2025). *2025 Singapore PSLE school rankings: Where do the top schools stand this year?* Sophia Education. https://sophiaeducation.sg/2025-singapore-psle-school-rankings

## [APPENDIX]{style="color: #E45A92;"}

## I. gwRF Hybrid Modeling

### i. Adjust spatial effects

Given that gwRF unexpectedly underperformed relative to RF, we explore whether a hybrid approach can improve performance by balancing local spatial effects (60%) with global patterns (40%). This configuration allows the model to capture spatial heterogeneity while maintaining awareness of market-wide trends.

```{r}
#| eval: false
#| code-fold: true
gwRF_hybrid_pred <- predict.grf(gwRF_adaptive,
                         test_data_gwrf,
                         x.var.name = "X",
                         y.var.name = "Y",
                         local.w = 0.6,
                         global.w = 0.4)

gwRF_hybrid_pred <- write_rds(gwRF_hybrid_pred, "data/model/gwRF_hybrid_pred.rds")
```

```{r}
#| echo: false
gwRF_hybrid_pred <- read_rds("data/model/gwRF_hybrid_pred.rds")

```

### ii. Append predicted values to the test dataset

```{r}
#| eval: false
#| code-fold: true

gwRF_hybrid_pred_df <- as.data.frame(gwRF_hybrid_pred)
test_data_p$gwrf_hybrid_pred <- gwRF_hybrid_pred_df[, 1]
write_rds(test_data_p, "data/rds/test_data_p.rds")
```

```{r}
#| echo: false
test_data_p <- read_rds("data/rds/test_data_p.rds")
kable(head(test_data_p))

```

### iii. gwRF Model performance metrics

```{r}
#| code-fold: true
#| eval: false
# RMSE
gwrf_hybrid_rmse <- sqrt(mean((test_data_p$resale_price - test_data_p$gwrf_hybrid_pred)^2))

# MAE
gwrf_hybrid_mae <- mean(abs(test_data_p$resale_price - test_data_p$gwrf_hybrid_pred))

# R^2
gwrf_hybrid_rsq <- cor(test_data_p$resale_price, test_data_p$gwrf_hybrid_pred)^2

write_rds(gwrf_hybrid_rmse, "data/rds/gwrf_hybrid_rmse.rds")
write_rds(gwrf_hybrid_mae, "data/rds/gwrf_hybrid_mae.rds")
write_rds(gwrf_hybrid_rsq, "data/rds/gwrf_hybrid_rsq.rds")
```

```{r}
#| code-fold: true
#| echo: false

gwrf_hybrid_rmse <- read_rds("data/rds/gwrf_hybrid_rmse.rds")
gwrf_hybrid_mae <- read_rds("data/rds/gwrf_hybrid_mae.rds")
gwrf_hybrid_rsq <- read_rds("data/rds/gwrf_hybrid_rsq.rds")

print(paste("gwRF_hybrid MSE:", rf_rmse))
print(paste("gwRF_hybrid MAE:", rf_mae))
print(paste("gwRF_hybrid R^2:", rf_rsq))
```

### iv. Visualising the predicted values

Let's visualise the actual resale price and the predicted resale price in the scatter plot and compare the metrics with the existing models.

While the hybrid gwRF model improves upon fully localised gwRF, it still underperforms compared to non-spatial Random Forest. This result suggests that explicit geographic weighting may not be necessary when rich locational features (proximity to amenities, CBD distance) are already included as predictors.

Random Forest's ability to capture complex non-linear interactions between these spatial features may be more effective than gwRF's localized approach for this dataset.

::: panel-tabset
## Performance metrics table

```{r}
#| code-fold: true

model_comparison_v2 <- data.frame(
  Model = c("MLR", "GWR", "Random Forest", "gwRF", "gwRF_hb"),
  RMSE = c(rmse_mlr, gwr_rmse, rf_rmse, gwrf_rmse, gwrf_hybrid_rmse),
  MAE = c(mae_mlr, gwr_mae, rf_mae, gwrf_mae, gwrf_hybrid_mae),
  R_2 = c(r2_mlr, gwr_rsq, rf_rsq, gwrf_rsq, gwrf_hybrid_rsq)
)

datatable(model_comparison_v2,
          options = list(pageLength = 10, dom = 't'),
          rownames = FALSE,
          class = 'cell-border stripe') %>%
  formatRound(columns = c('RMSE', 'MAE', 'R_2'), digits = 4) 
```

## Scatterplot

```{r}
#| code-fold: true
ggplot(data = test_data_p,
       aes(x = gwrf_hybrid_pred,
           y = resale_price)) +
  geom_point(col = "#BB6653", size = 0.5) +
  geom_abline(intercept = 0, slope = 1, 
               color = "#DC143C", linetype = "dashed", linewidth = 1) +  
  labs(title = "GWRF Hybrid: Predicted vs Actual Resale Prices",
       x = "Predicted Resale Price (S$)",
       y = "Actual Resale Price (S$)") +
    theme_minimal() +  
  theme(
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") 
  )  
  
```
:::

## II. gwRF bandwidth sensitivity analysis

### i. Adjust bandwidth

We conducted a further bandwidth sensitivity analysis testing values from 48, 75, 100, 150 to 200 neighbors.

```{r}
#| eval: false
#| code-fold: true

bandwidths <- c(48, 75, 100, 150, 200)
gwrf_results <- data.frame()

for(bw in bandwidths) {
  set.seed(1234)
  gwRF_test <- grf(
    formula = resale_price ~ 
    floor_level + floor_area_sqm + 
    remaining_lease_mths_num + PROX_HKCENTER + 
    PROX_SUPERMKT +PROX_ELDERCARE + PROX_MALLS +
    PROX_SPORTS + PROX_CC + PROX_MRT + PROX_CBD +
    PROX_BIZPK + WITHIN_1km_TOPPRISCH_BINARY + 
    WITHIN_500m_HKC_BINARY + WITHIN_350m_KINDG + 
    WITHIN_350m_CHILDC + WITHIN_350m_BUS + WITHIN_1km_PRISCH,
    dframe = train_data_nogeom, 
    bw = bw,
    kernel = "adaptive",
    coords = coords_train,
    ntree = 500,
    mtry = 3
  )
  
  gwRF_test_pred <- predict.grf(
    gwRF_test,
    test_data_gwrf,
    x.var.name = "X",
    y.var.name = "Y",
    local.w = 0.6,
    global.w = 0.4
  )
  
  predictions <- as.data.frame(gwRF_test_pred)[,1]
  
  test_actual <- as.numeric(test_data_p$resale_price)

gwrf_results <- rbind(gwrf_results, data.frame(
  Bandwidth = bw,
  RMSE = sqrt(mean((test_actual - predictions)^2)),
  MAE = mean(abs(test_actual - predictions)),
  R_squared = cor(test_actual, predictions)^2
))
  
  print(paste("Completed bandwidth:", bw))
}

write_rds(gwrf_results, "data/rds/gwrf_results.rds")
```

```{r}
#| echo: false
gwrf_results <- read_rds("data/rds/gwrf_results.rds")
kable(gwrf_results)

```

### ii. Result visualisation

```{r}
#| code-fold: true
p_h <- ggplot(gwrf_results, aes(x = Bandwidth, y = RMSE,
                                text = paste0(
                                   "<b>Bandwidth:</b> ", Bandwidth,
                                   "<br><b>RMSE:</b> $", format(round(RMSE, 2), big.mark = ","),
                                   "<br><b>Improvement vs RF:</b> $", format(round(41950 - RMSE, 2), big.mark = ",")
                                 ))) +
  geom_line(color = "orange", linewidth = 1, aes(text = NULL)) +
  geom_point(color = "orange", size = 3) +
  geom_hline(yintercept = 41950, color = "blue", linetype = "dashed", linewidth = 1) +
  geom_hline(yintercept = 38028, color = "red", linetype = "dashed", linewidth = 1) +
  annotate("text", x = max(gwrf_results$Bandwidth), y = 41950, 
           label = "Random Forest", hjust = 1.1, color = "blue") +
  annotate("text", x = max(gwrf_results$Bandwidth), y = 38028, 
           label = "GWR", hjust = 1.1, color = "red") +
  labs(title = "gwRF Performance by Bandwidth",
       subtitle = "Hybrid model (60% local, 40% global)",
       x = "Adaptive Bandwidth (Number of Neighbors)",
       y = "RMSE (SGD)") +
  theme_minimal() +
    theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    strip.text = element_text(size = 11, face = "bold"),
    plot.background = element_rect(fill = "#EEEEEE"),      
    panel.background = element_rect(fill = "#F5F5F5"),   
    panel.border = element_rect(color = "white", fill = NA, linewidth = 1),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10))

ggplotly(p_h, tooltip = "text")
```

### iii. Conclusion

Results showed that increasing bandwidth improved gwRF performance (RMSE: 46,306 at BW=48 → 41,396 at BW=200), yet even optimal gwRF's MAE underperformed standard RF (RMSE=29,540). This reveals a fundamental paradox: gwRF requires larger bandwidths to improve accuracy, but this negates the local spatial weighting that motivated its design. The consistent superiority of RF suggests that spatial dependencies are adequately represented through proximity features. They make explicit geographic weighting unnecessary, and potentially harmful when combined with tree-based ensemble methods.
